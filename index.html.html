<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>핵심 간호술기 학습 플랫폼 (LAMP)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .skill-item {
            transition: all 0.3s ease;
        }
        .skill-item:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }
        .progress-bar-fill {
            transition: width 1s ease-in-out;
        }
        /* Style for the button on the welcome screen */
        .start-button {
            animation: pulse-shadow 2s infinite;
        }
        @keyframes pulse-shadow {
            0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(79, 70, 229, 0); }
            100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); }
        }
        /* Rationale visibility transition */
        .rationale-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out;
        }
        .rationale-container.visible {
            max-height: 200px; /* Sufficient height for content */
            padding-bottom: 0.75rem; /* pb-3 */
            padding-top: 0.5rem; /* pt-2 */
        }

    </style>

    <!-- Firebase SDK Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let currentUserId = null;

        if (Object.keys(firebaseConfig).length === 0) {
            console.error("Firebase configuration is missing.");
            document.getElementById('app-container').innerHTML = '<div class="p-8 text-center text-red-600 bg-red-100 rounded-lg">Firebase 설정이 필요합니다. 환경 설정을 확인해주세요.</div>';
        } else {
            // Initialize Firebase only if config exists
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            setLogLevel('debug');

            // Global variables for App Logic
            window.db = db;
            window.auth = auth;
            window.appId = appId;
            window.currentUserId = currentUserId;

            // Sign In and Auth State Handling
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    window.currentUserId = currentUserId;
                    console.log("Authenticated with UID:", currentUserId);
                } else {
                    console.log("No user signed in. Attempting anonymous sign-in...");
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Authentication Error:", error);
                    }
                }
                document.getElementById('user-id-display').textContent = '사용자 ID: ' + (currentUserId || '로그인 중...');
                window.setupDataListeners(); // Call setup function once authenticated
            });
        }
    </script>

    <!-- Application Logic Script -->
    <script type="module">
        import { getFirestore, onSnapshot, collection, query, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GEMINI API Setup ---
        const API_KEY = ""; // Leave as-is for Canvas environment
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        const VIDEO_URL = "http://yswpub3.synology.me/smspdf/revision2023_song_fundamentalsofnursing_video/2023_QR_11.mp4"; // User Request 2

        /**
         * Calls the Gemini API with exponential backoff.
         */
        async function fetchGeminiContent(userQuery, systemPrompt, maxRetries = 3) {
            const apiKey = API_KEY;
            const url = `${API_URL}?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && attempt < maxRetries - 1) {
                            const delay = Math.pow(2, attempt) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue; // Retry
                        }
                        throw new Error(`API call failed with status: ${response.status}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (text) {
                        return text;
                    } else {
                        throw new Error("API response text is empty or malformed.");
                    }
                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error);
                    if (attempt === maxRetries - 1) throw error; 
                    const delay = Math.pow(2, attempt) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // --- SKILL DATA ---
        const CORE_SKILLS = [
            { name: "활력징후 측정", difficulty: "하", linkId: "vital-signs", emoji: "🩺" },
            { name: "경구투약", difficulty: "하", linkId: "mock", emoji: "💊" },
            { name: "근육주사", difficulty: "중", linkId: "mock", emoji: "💉" },
            { name: "피하주사(간이 혈당검사 포함)", difficulty: "중", linkId: "mock", emoji: "🩸" },
            { name: "피내주사(전완의 내측면)", difficulty: "상", linkId: "mock", emoji: "🧪" },
            { name: "정맥수액 주입(Infusionpump 혹은 syringepump 사용 포함)", difficulty: "상", linkId: "mock", emoji: "💧" },
            { name: "수혈요법", difficulty: "상", linkId: "mock", emoji: "❤️" },
            { name: "간헐적 위관영양", difficulty: "중", linkId: "mock", emoji: "🥣" },
            { name: "단순도뇨(Straight catheterization)", difficulty: "중", linkId: "mock", emoji: "🚽" },
            { name: "유치도뇨(Indwelling catheterization)", difficulty: "상", linkId: "mock", emoji: "💦" },
            { name: "배출관장", difficulty: "중", linkId: "mock", emoji: "🍑" },
            { name: "말초산소포화도(Pulse oximeter) 측정과 심전도 모니터(EKG monitor) 적용", difficulty: "하", linkId: "mock", emoji: "📟" },
            { name: "비강캐뉼라를 이용한 산소요법", difficulty: "하", linkId: "mock", emoji: "🌬️" },
            { name: "흡인(Suction)", difficulty: "상", linkId: "mock", emoji: "😷" },
            { name: "기본 심폐소생술 및 제세동기 적용", difficulty: "중", linkId: "mock", emoji: "⚡" },
            { name: "통증관리", difficulty: "중", linkId: "mock", emoji: "🩹" },
            { name: "욕창관리 및 낙상예방간호", difficulty: "하", linkId: "mock", emoji: "🛏️" },
            { name: "배액관 관리(JP또는 Hemovac)", difficulty: "중", linkId: "mock", emoji: "🗑️" }
        ];

        // --- VITAL SIGN LEARNING STEPS (Used for Procedure Learning Tab Navigation) ---
        const VITAL_SIGN_STEPS = [
            { id: 1, title: "준비 및 환자 확인", procedure: "물과 비누 또는 알코올 기반 손 소독제를 이용하여 손 위생을 실시하고, 환자에게 체온, 맥박, 호흡, 혈압 측정을 설명한 후 동의를 구하고 필요한 장비를 준비한다.", terms: ["Hand Hygiene", "Informed Consent"] },
            { id: 2, title: "체온 측정 (Temperature)", procedure: "구강, 액와, 고막, 또는 직장 체온 중 적절한 방법을 선택하고 정확한 측정 부위에 체온계를 위치시킨다. 결과는 즉시 확인하고 기록한다.", terms: ["Oral Temp", "Axillary Temp", "Tympanic Temp"] },
            { id: 3, title: "맥박 측정 (Pulse)", procedure: "요골동맥(Radial artery)을 촉지하여 맥박의 규칙성과 강도를 확인하고, 1분 동안 측정한다. 맥박수가 불규칙할 경우 심첨 맥박을 측정한다.", terms: ["Radial Pulse", "Apical Pulse", "Tachycardia", "Bradycardia"] },
            { id: 4, title: "호흡 측정 (Respiration)", procedure: "맥박 측정 후 손을 떼지 않고 환자에게 알리지 않은 상태로 가슴의 오르내림을 관찰하며 1분 동안 측정한다. 깊이와 리듬도 함께 확인한다.", terms: ["Dyspnea", "Tachypnea", "Bradypnea"] },
            { id: 5, title: "혈압 측정 (Blood Pressure)", procedure: "대상자를 안정시키고 팔을 심장 높이에 둔다. 커프를 정확히 감고 청진기로 심음(Korotkoff sound)을 들으면서 수축기/이완기 혈압을 측정한다. 측정 후 커프의 공기를 완전히 제거한다.", terms: ["Systolic BP", "Diastolic BP", "Hypertension", "Hypotension"] },
            { id: 6, title: "기록 및 마무리", procedure: "측정된 활력징후 결과를 즉시 기록하고, 사용한 장비를 정리하며 손 위생으로 마무리한다. 특이사항을 환자에게 알리고 필요한 추가 조치를 취한다.", terms: ["Charting", "Baseline Data"] }
        ];
        
        // --- FULL CHECKLIST DATA (Includes Rationale for User Request 3) ---
        const VITAL_SIGN_CHECKLIST_DATA = [
            { item: "물과 비누로 손위생을 실시한다.", rationale: "미생물 전파를 방지함." }, // User request 3
            { item: "필요한 물품을 준비하고, 작동여부를 확인한다.(청진기, 체온계, 혈압계)", rationale: "정확한 측정을 보장하고 술기 시간을 단축합니다." },
            { item: "준비한 물품을 가지고 대상자에게 가서 간호사 자신을 소개한다.", rationale: "환자의 불안을 감소시키고 라포(Rapport)를 형성합니다." },
            { item: "손소독제로 손위생을 실시한다.", rationale: "감염 관리를 위한 추가적인 예방 조치입니다." },
            { item: "대상자의 이름을 개방형으로 질문하여 대상자를 확인하고, 입원팔찌와 환자리스트(또는 처방지)를 대조하여 대상자(이름, 등록번호)를 확인한다.", rationale: "안전을 위해 투약 및 처치 전 정확한 대상자 확인은 필수입니다. (개방형 질문)" },
            { item: "대상자에게 체온, 맥박, 호흡, 혈압을 측정하는 목적과 절차를 설명한다.", rationale: "환자의 협조를 얻고, 불안을 완화하며, 알 권리를 충족시킵니다." },
            { item: "[액와 체온계] 전자체온계를 꺼내어 끝부분을 소독솜으로 닦은 후 겨드랑이 중앙에 삽입하여 체온계가 빠지지 않도록 지지한다.", rationale: "체온계의 정확한 소독과 측정 부위의 정확한 위치는 정확한 체온 측정을 위해 중요합니다." },
            { item: "[액와 체온계] 대상자에게 체온이 측정될 때까지 체온계가 유지되도록 설명한다.", rationale: "측정 시간 동안 움직임을 최소화하여 오류를 방지합니다." },
            { item: "[고막체온계] 용기에서 탐침 덮개를 꺼낸 후 탐침 덮개를 고막체온계에 덮는다.", rationale: "교차 감염을 예방하고 측정의 정확성을 높입니다." },
            { item: "[고막체온계] 대상자의 머리를 한 쪽으로 돌려 체온을 측정할 귀를 노출시킨 후 귓바퀴를(성인의 귓바퀴는 후상방으로 소아는 후하방으로) 당긴 다음 탐침을 부드럽게 외이도로 삽입하여 체온을 측정한다.", rationale: "고막체온계의 탐침을 고막으로 향하게 하여 정확한 중심체온을 측정하기 위함입니다." },
            { item: "[고막체온계] 탐침 덮개를 제거 한 후에 체온을 메모한다.", rationale: "사용 후 즉시 덮개를 제거하여 오염된 상태를 방지합니다." },
            { item: "대상자의 팔을 편한 자세로 놓고, 대상자의 이불을 내려 가슴이 보이도록 한다.", rationale: "호흡 측정을 용이하게 하고 환자의 편안함을 유지하기 위함입니다." },
            { item: "손가락으로 요골동맥을 찾아서 그 위에 놓고, 맥박 부위를 확인한 후, 맥박을 측정한다. (처음 입원 시) 1분간 맥박수를 측정한다. (입원 중 규칙적임을 확인한 후) 30초 동안 맥박수를 측정한 후 2배를 한다.", rationale: "정확한 맥박수, 리듬, 강도를 파악하고, 불규칙할 경우 오차를 줄이기 위해 1분 전체를 측정해야 합니다." },
            { item: "맥박을 측정한 후 동맥에 손을 그대로 댄 채로 호흡을 측정한다. (처음 입원 시) 1분간 호흡수를 측정한다. (입원 중) 30초 동안 호흡수를 측정한 후 2배를 한다.", rationale: "호흡은 의식적인 조절이 가능하므로, 환자가 호흡을 의식하지 않도록 맥박 측정 직후 측정합니다." },
            { item: "체온이 측정되면 체온계를 빼고, 소독솜으로 닦은 후 체온계의 전원을 끄고 용기에 넣는다.", rationale: "장비를 청결하게 유지하고 전력 소비를 줄이기 위함입니다." },
            { item: "측정된 맥박과 호흡, 체온을 메모한다.", rationale: "오류를 방지하고 간호 기록 전까지 데이터를 임시로 보존합니다." },
            { item: "대상자가 편안한 자세를 취하게 한 후, 대상자의 팔을 심장과 같은 높이로 놓고 팔을 노출시킨다.", rationale: "정확한 혈압 측정을 위해 커프 위치가 심장 높이와 일치해야 합니다." },
            { item: "팔오금 상완동맥 2~3cm위에 커프의 bulb에 연결된 줄이 상완동맥과 평행이 되게 놓이도록 하고 손가락 하나가 들어갈 정도의 여유를 주고 감는다.", rationale: "커프의 부적절한 위치는 오차를 유발하며, 적절한 밀착은 압력을 정확하게 전달합니다." },
            { item: "참고: 혈압 초기 측정을 위해 상완동맥을 촉지하여 맥박 소실 지점을 확인한다. (30mmHg 더 올림)", rationale: "청진을 시작할 압력을 결정하여 청진상의 오차(Auscultatory Gap)를 예방합니다." },
            { item: "혈압계의 조절 밸브를 잠그고 압력 bulb를 눌러 혈압계의 눈금이 160~200mmHg까지 올라가게 공기를 넣는다.", rationale: "일반적으로 160~200mmHg까지 압력을 가하여 동맥을 완전히 폐쇄시킵니다." },
            { item: "조절 밸브를 천천히 열어 1초에 2mmHg씩 눈금을 내리면서 처음 소리가 들리는 지점의 눈금을 읽어서 기억한다.", rationale: "수축기 혈압(Systolic BP)을 정확히 측정하기 위해 압력을 천천히 내립니다." },
            { item: "조절 밸브를 천천히 열어 차츰 커프에서 공기를 빼면서 소리가 없어지는 지점의 눈금을 읽어서 기억한다.", rationale: "이완기 혈압(Diastolic BP)을 정확히 측정하기 위해 소실되는 지점을 확인합니다." },
            { item: "조절 밸브를 완전히 열어 커프에서 공기를 완전히 뺀 후 커프를 풀어, 혈압계를 정리한다.", rationale: "혈액 순환을 방해하지 않고 장비를 보호합니다." },
            { item: "대상자의 환의를 정리한다. 측정된 혈압을 메모한다.", rationale: "환자의 프라이버시를 존중하고 다음 간호 기록을 준비합니다." },
            { item: "청진기의 귀꽂이(ear piece)와 판막(diaphragm)을 소독솜으로 닦는다. 물과 비누로 손위생을 실시한다. 간호기록지에 호흡, 체온, 맥박, 혈압측정치를 기록한다.", rationale: "감염 관리를 마무리하고 측정 결과를 공식적으로 기록하여 후속 간호에 활용합니다." }
        ];
        
        // --- END VITAL SIGN DATA ---

        // State Management 
        let currentStep = 1; // For Procedure Learning Tab (1-6 steps)
        let fullChecklistState = {}; // State for the full 25-item checklist
        
        // --- Core View Management ---

        /**
         * Switches the main screen view.
         */
        function showView(viewId, initialSubView = null) {
            console.log(`Switching main view to: ${viewId}`); // Debug log
            const views = document.querySelectorAll('.app-view-main');
            views.forEach(view => view.classList.add('hidden'));

            const activeView = document.getElementById(viewId);
            if (activeView) {
                activeView.classList.remove('hidden');
                
                if (viewId === 'skill-list-view') {
                    renderSkillList();
                } else if (viewId === 'procedure-detail-view') {
                    // Default to the Overview View
                    renderSubView(initialSubView || 'overview-view');
                }
            }
            
            // Hide/Show 'back to list' button
            const backButton = document.getElementById('back-to-list-btn');
            if (viewId === 'skill-list-view' || viewId === 'welcome-view') {
                backButton.classList.add('hidden');
            } else {
                backButton.classList.remove('hidden');
            }
        }
        window.showView = showView;
        
        /**
         * Switches the sub-view (tabs) within the procedure detail screen.
         */
        function renderSubView(viewId) {
            console.log(`Switching sub view to: ${viewId}`); // Debug log
            const views = document.querySelectorAll('.app-view-sub');
            views.forEach(view => {
                view.classList.add('hidden');
                view.classList.remove('flex');
            });

            const activeView = document.getElementById(viewId);
            if (activeView) {
                activeView.classList.remove('hidden');
                activeView.classList.add('flex');
            }

            // Update navigation active state
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('bg-indigo-600', 'text-white', 'shadow-inner');
                link.classList.add('text-indigo-700', 'hover:bg-indigo-100');
            });
            const activeLink = document.querySelector(`.nav-link[data-view="${viewId}"]`);
            if (activeLink) {
                activeLink.classList.add('bg-indigo-600', 'text-white', 'shadow-inner');
                activeLink.classList.remove('text-indigo-700', 'hover:bg-indigo-100');
            }
            
            // Specific rendering for each tab
            if (viewId === 'overview-view') {
                renderOverviewView();
            } else if (viewId === 'procedure-learning-view') {
                renderProcedureLearningView();
            } else if (viewId === 'checklist-view') {
                renderChecklistView();
            } else if (viewId === 'charting-view') {
                renderChartingView();
            } else if (viewId === 'progress-view') {
                 // Data is automatically rendered by onSnapshot listener setup
            }
            // Hide/Show step navigation based on the active tab
            const stepNav = document.getElementById('step-navigation');
            if (viewId === 'procedure-learning-view') {
                 stepNav.classList.remove('hidden');
            } else {
                 stepNav.classList.add('hidden');
            }
        }
        window.renderSubView = renderSubView;


        // --- Skill List View Logic ---

        function getDifficultyClass(difficulty) {
            switch (difficulty) {
                case "하": return "bg-green-100 text-green-700 border-green-300";
                case "중": return "bg-yellow-100 text-yellow-700 border-yellow-300";
                case "상": return "bg-red-100 text-red-700 border-red-300";
                default: return "bg-gray-100 text-gray-700 border-gray-300";
            }
        }

        function renderSkillList() {
            const listContainer = document.getElementById('skill-list-container');
            
            const html = CORE_SKILLS.map(skill => {
                const isDemo = skill.linkId === 'vital-signs';
                const buttonClass = isDemo ? 'bg-indigo-500 hover:bg-indigo-600' : 'bg-gray-400 cursor-not-allowed';
                const buttonText = isDemo ? '학습 시작' : '개발 예정';
                const onClick = isDemo ? `showSkillDetail('${skill.name}')` : `showMessageBox('준비 중', '다른 술기 학습 모듈은 현재 개발 예정입니다.', 'info')`;

                return `
                    <div class="skill-item p-4 bg-white rounded-xl shadow-md flex justify-between items-center border border-gray-200">
                        <div class="flex items-center flex-1 min-w-0">
                            <span class="text-3xl mr-3">${skill.emoji}</span>
                            <div>
                                <h3 class="font-semibold text-lg text-gray-800 truncate">${skill.name}</h3>
                                <span class="inline-block mt-1 px-3 py-1 text-xs font-medium rounded-full border ${getDifficultyClass(skill.difficulty)}">
                                    난이도: ${skill.difficulty}
                                </span>
                            </div>
                        </div>
                        <button onclick="${onClick}" class="ml-4 px-4 py-2 text-sm font-medium text-white rounded-lg ${buttonClass} transition-colors">
                            ${buttonText}
                        </button>
                    </div>
                `;
            }).join('');
            
            listContainer.innerHTML = html;
        }

        function showSkillDetail(skillName) {
            if (skillName === "활력징후 측정") {
                showView('procedure-detail-view', 'overview-view'); // Default to '개요' tab
            } else {
                showMessageBox('개발 예정', `${skillName} 학습 모듈은 현재 준비 중입니다.`, 'info');
            }
        }
        window.showSkillDetail = showSkillDetail;

        // --- New Feature: Overview View Logic (User Request 1: Single Marker) ---
        function renderOverviewView() {
            const view = document.getElementById('overview-view');
            
            // 1. 성취 목표 (Learning Objectives) - Requested Content
            const learningObjectives = [
                "체온, 맥박, 호흡, 혈압의 기전을 설명할 수 있다.",
                "체온, 맥박, 호흡, 혈압을 측정할 수 있다.",
                "체온, 맥박, 호흡, 혈압의 측정 결과를 기록할 수 있다."
            ];

            // 2. 선행 지식 (Prerequisite Knowledge)
            const prerequisiteKnowledge = [
                "체온, 맥박, 호흡, 혈압의 정의와 정상범위",
                "체온, 맥박, 호흡, 혈압에 영향을 미치는 요인"
            ];

            // 3. 준비 물품 (Preparation Items)
            const preparationItems = [
                "초침이 있는 시계",
                "전자 체온계/고막 체온계(1회용 탐침 덮개)",
                "아네로이드 혈압계",
                "청진기(교육용 청진기 준비)",
                "손소독제",
                "쟁반(Tray), 곡반",
                "소독솜",
                "간호기록지",
                "의료폐기물 전용용기(일반)"
            ];

            // User Request 1: Modified renderList to use a single custom marker (flex/span)
            const renderList = (items) => items.map(item => `
                <li class="text-gray-700 mb-2 flex items-start">
                    <span class="mr-2 text-indigo-500 font-bold">•</span>
                    <span class="flex-1">${item}</span>
                </li>`).join('');


            view.innerHTML = `
                <div class="flex flex-col flex-1 p-4 overflow-y-auto">
                    <h3 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">📋 활력징후 측정 (Vital Signs) 개요</h3>
                    
                    <!-- 1. 성취 목표 -->
                    <div class="bg-indigo-50 p-5 rounded-xl shadow-md mb-6 border border-indigo-200">
                        <p class="font-bold text-indigo-700 mb-3 flex items-center"><i data-lucide="target" class="w-5 h-5 mr-2"></i> 성취 목표</p>
                        <ul class="space-y-2 text-sm">
                            ${renderList(learningObjectives)}
                        </ul>
                    </div>

                    <!-- 2. 선행 지식 -->
                    <div class="bg-white p-5 rounded-xl shadow-md mb-6 border border-gray-200">
                        <p class="font-bold text-gray-700 mb-3 flex items-center"><i data-lucide="book-open" class="w-5 h-5 mr-2 text-green-600"></i> 선행 지식</p>
                        <ul class="space-y-2 text-sm">
                            ${renderList(prerequisiteKnowledge)}
                        </ul>
                    </div>

                    <!-- 3. 준비 물품 -->
                    <div class="bg-white p-5 rounded-xl shadow-md mb-6 border border-gray-200">
                        <p class="font-bold text-gray-700 mb-3 flex items-center"><i data-lucide="shopping-bag" class="w-5 h-5 mr-2 text-red-600"></i> 준비 물품</p>
                        <ul class="space-y-2 text-sm">
                            ${renderList(preparationItems)}
                        </ul>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }
        window.renderOverviewView = renderOverviewView;

        // --- Feature 1: Clinical Tip Generation (in Procedure Learning View) ---
        async function getClinicalTip() {
            const stepData = VITAL_SIGN_STEPS[currentStep - 1];
            const tipBox = document.getElementById('clinical-tip-box');
            const button = document.getElementById('get-tip-btn');
            
            if (!stepData) return;

            button.disabled = true;
            button.innerHTML = '<i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i> 팁 생성 중...';
            lucide.createIcons();
            tipBox.innerHTML = '<p class="text-gray-500 italic">Gemini가 임상 팁을 생성하고 있습니다...</p>';

            const systemPrompt = "You are a senior clinical nurse with over 10 years of experience. Your task is to provide a concise, real-world clinical tip or warning about a common pitfall for the specific nursing procedure step provided. Keep the tone professional but practical. Respond in Korean. Use Markdown formatting (bold, lists) for clarity, but only use Korean text.";
            const userQuery = `핵심 간호 술기 단계: ${stepData.title}\n절차: ${stepData.procedure}\n\n이 단계에서 초보 간호사가 흔히 저지르는 실수나, 반드시 지켜야 할 임상적 팁을 2~3문장 이내로 제공해 주세요.`;

            try {
                const tip = await fetchGeminiContent(userQuery, systemPrompt);
                tipBox.innerHTML = `
                    <div class="bg-yellow-50 p-4 rounded-lg border-l-4 border-yellow-500 shadow-sm">
                        <p class="font-bold text-yellow-800 mb-2 flex items-center">
                            <i data-lucide="sparkles" class="w-5 h-5 mr-1 fill-yellow-500 text-yellow-500"></i> 임상 현장 팁
                        </p>
                        <div class="text-sm text-gray-700 prose">${tip}</div>
                    </div>
                `;
            } catch (error) {
                tipBox.innerHTML = '<p class="text-red-500">팁 생성 중 오류 발생: 잠시 후 다시 시도해 주세요.</p>';
            } finally {
                button.disabled = false;
                button.innerHTML = '<i data-lucide="sparkles" class="w-5 h-5 mr-2 fill-white text-white"></i> 임상 팁 받기';
                lucide.createIcons();
            }
        }
        window.getClinicalTip = getClinicalTip;

        // --- Procedure Learning View Logic (Main procedure content) ---

        function renderProcedureLearningView() {
            const view = document.getElementById('procedure-learning-view');
            const stepData = VITAL_SIGN_STEPS[currentStep - 1];
            
            if (!stepData) return;

            // Update procedure title (Shared title, only update here)
            document.getElementById('procedure-title-step-count').textContent = `| 단계 ${currentStep} / ${VITAL_SIGN_STEPS.length}`;

            let html = `
                <!-- Procedure Content Area -->
                <div id="procedure-content" class="p-4 bg-gray-50 rounded-lg shadow-inner mb-6 flex-1">
                    <h4 class="text-lg font-bold text-indigo-700 mb-3">${stepData.title}</h4>
                    
                    <!-- YouTube Video Link (User Request 2) -->
                    <div class="aspect-video bg-gray-100 rounded-lg mb-6 flex flex-col items-center justify-center text-gray-600 p-4 border border-indigo-200">
                        <p class="text-sm mb-3">활력징후 측정 실습 영상 (QR_11)</p>
                        <a href="${VIDEO_URL}" target="_blank" class="flex items-center justify-center px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition-colors shadow-md text-sm">
                            <i data-lucide="monitor-play" class="w-5 h-5 mr-2"></i> 영상 보기 (새 창 열림)
                        </a>
                    </div>

                    <!-- Procedure Step Details -->
                    <div class="bg-indigo-50 p-4 rounded-lg mb-6 border-l-4 border-indigo-500">
                        <p class="font-semibold text-indigo-700 mb-2">핵심 술기 절차</p>
                        <p class="text-gray-700">${stepData.procedure}</p>
                    </div>
                    
                    <!-- Gemini Clinical Tip Button and Output -->
                    <div id="clinical-tip-container" class="mb-6">
                        <button id="get-tip-btn" onclick="getClinicalTip()" class="flex items-center px-4 py-2 text-sm font-medium rounded-lg text-white bg-pink-500 hover:bg-pink-600 transition-colors shadow-md">
                            <i data-lucide="sparkles" class="w-5 h-5 mr-2 fill-white text-white"></i> 임상 팁 받기
                        </button>
                        <div id="clinical-tip-box" class="mt-3">
                            <!-- Gemini Output Here -->
                        </div>
                    </div>

                    <!-- Medical Terms -->
                    <div class="mb-6">
                        <p class="font-semibold text-gray-700 mb-2">핵심 의학 용어</p>
                        <div class="flex flex-wrap gap-2">
                            ${stepData.terms.map(term => `<span class="px-3 py-1 bg-gray-200 text-gray-700 text-sm rounded-full">${term}</span>`).join('')}
                        </div>
                    </div>

                </div>
            `;
            view.innerHTML = html;
            lucide.createIcons();
        }
        window.renderProcedureLearningView = renderProcedureLearningView;

        function changeStep(delta) {
            currentStep = Math.max(1, Math.min(VITAL_SIGN_STEPS.length, currentStep + delta));
            
            // Reset tip box and re-render the learning view
            const tipBox = document.getElementById('clinical-tip-box');
            if (tipBox) tipBox.innerHTML = '';
            
            // Rerender procedure learning view
            renderProcedureLearningView();
        }
        window.changeStep = changeStep;
        
        // --- Checklist View Logic (Self-Assessment & Rationale Toggle - User Request 3) ---
        
        /**
         * 체크박스 상태를 토글하고 이론적 근거의 가시성을 업데이트합니다. (스크롤 튕김 현상 해결을 위해 DOM 직접 조작으로 변경됨)
         * @param {HTMLInputElement} checkboxEl - 체크박스 요소
         * @param {string} index - 체크리스트 항목의 인덱스 (문자열)
         */
        function handleChecklistToggle(checkboxEl, index) {
            // 1. 상태 업데이트
            const isChecked = checkboxEl.checked;
            fullChecklistState[index] = isChecked;

            // 2. 항목 컨테이너의 클래스 업데이트 (스크롤 튕김 문제 해결 핵심)
            const parentDiv = checkboxEl.closest('.checklist-item-container');
            if (parentDiv) {
                // 기존 배경/경계 스타일 클래스 제거
                parentDiv.classList.remove('bg-green-50', 'border-green-300', 'shadow-sm', 'bg-gray-50', 'hover:bg-gray-100', 'border-gray-200');

                // 상태에 따른 새 클래스 추가
                if (isChecked) {
                    parentDiv.classList.add('bg-green-50', 'border', 'border-green-300', 'shadow-sm');
                } else {
                    parentDiv.classList.add('bg-gray-50', 'hover:bg-gray-100', 'border', 'border-gray-200');
                }
            }


            // 3. 이론적 근거 DOM 업데이트 (visible 클래스 토글)
            const rationaleEl = document.getElementById(`rationale-${index}`);
            if (rationaleEl) {
                if (isChecked) {
                    rationaleEl.classList.add('visible');
                    rationaleEl.classList.remove('hidden'); // Ensure it starts the transition from not hidden
                } else {
                    rationaleEl.classList.remove('visible');
                    // 'hidden'은 max-height:0 트랜지션 후에 자연스럽게 발생
                }
            }
            
            // NOTE: 스크롤 튕김 현상 해결을 위해 renderChecklistView() 호출을 제거함
            console.log(`Checklist item ${index} toggled. Scroll position preserved.`);
        }
        window.handleChecklistToggle = handleChecklistToggle;
        

        function renderChecklistView() {
            const view = document.getElementById('checklist-view');
            const totalItems = VITAL_SIGN_CHECKLIST_DATA.length;
            
            let checklistHtml = `
                <div class="flex flex-col flex-1">
                    <h3 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">✅ 활력징후 측정 전체 술기 체크리스트 (총 ${totalItems} 항목)</h3>
                    
                    <!-- Assessment Content -->
                    <div class="p-6 bg-white rounded-xl shadow-lg mt-2 border-2 border-indigo-200 flex-1 overflow-y-auto">
                        <p class="text-gray-600 mb-4 font-semibold text-lg">전체 술기 수행 점검</p>
                        <p class="text-sm text-gray-500 mb-4">전체 술기 과정(${totalItems}개 항목)을 스스로 평가하고 체크하세요. 항목 체크 시 이론적 근거가 표시됩니다.</p>
                        <div id="checklist-items" class="space-y-3 max-h-[450px] overflow-y-auto pr-2">
                `;
                
                VITAL_SIGN_CHECKLIST_DATA.forEach((data, index) => {
                    const itemId = `check-${index}`;
                    const isChecked = fullChecklistState[index] || false;
                    const isRationaleVisible = isChecked ? 'visible' : '';
                    const hiddenClass = isChecked ? '' : 'hidden'; // Initial visibility based on state

                    checklistHtml += `
                        <!-- checklist-item-container 클래스 추가 -->
                        <div class="rounded-xl overflow-hidden transition duration-150 ease-in-out checklist-item-container ${isChecked ? 'bg-green-50 border border-green-300 shadow-sm' : 'bg-gray-50 hover:bg-gray-100 border border-gray-200'}">
                            <label for="${itemId}" class="flex items-start p-3 cursor-pointer select-none">
                                <input type="checkbox" id="${itemId}" class="form-checkbox h-5 w-5 text-indigo-600 rounded mt-1 mr-3 focus:ring-indigo-500" 
                                       onchange="handleChecklistToggle(this, '${index}')" ${isChecked ? 'checked' : ''}>
                                <span class="text-base text-gray-800 flex-1">(${index + 1}) ${data.item}</span>
                            </label>
                            
                            <!-- Rationale Container (User Request 3) -->
                            <div id="rationale-${index}" class="rationale-container px-3 ${isRationaleVisible} ${hiddenClass}">
                                <div class="border-t border-green-200 mt-0 pt-2">
                                    <p class="font-semibold text-sm text-green-800 mb-1">💡 이론적 근거:</p>
                                    <p class="text-sm text-green-700">${data.rationale}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                checklistHtml += `
                        </div>
                        <button onclick="saveAssessment()" class="w-full mt-6 flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-xl shadow-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <i data-lucide="save" class="w-5 h-5 mr-2"></i> 평가 결과 저장 및 진도 기록
                        </button>
                    </div>
                </div>
            `;
            view.innerHTML = checklistHtml;
            lucide.createIcons();
        }
        window.renderChecklistView = renderChecklistView;
        

        async function saveAssessment() {
            if (!window.currentUserId) {
                showMessageBox('인증 오류', '사용자 인증 중입니다. 잠시 후 다시 시도해 주세요.', 'error');
                return;
            }

            const totalItems = VITAL_SIGN_CHECKLIST_DATA.length;
            
            // Calculate score based on the full checklist
            const completedItems = Object.keys(fullChecklistState).filter(key => fullChecklistState[key]).length;
            
            const score = (completedItems / totalItems) * 100;

            const assessmentData = {
                userId: window.currentUserId,
                skillId: 'vital-signs', // Fixed ID for the entire procedure
                skillTitle: '활력징후 측정 전체 술기',
                score: Math.round(score),
                totalItems: totalItems,
                completedItems: completedItems,
                checklistDetails: JSON.stringify(fullChecklistState), // Save entire state
                timestamp: serverTimestamp(),
                isCompleted: score === 100
            };

            const saveBtn = document.querySelector('#checklist-view button[onclick="saveAssessment()"]');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i> 저장 중...';

            try {
                const db = getFirestore();
                const progressRef = getSkillCollectionRef(db, window.appId, window.currentUserId);
                
                await addDoc(progressRef, assessmentData);
                
                showMessageBox(`'활력징후 측정' 평가 기록이 성공적으로 저장되었습니다!`, `점수: ${Math.round(score)}% (${completedItems}/${totalItems})`, 'success');

                // Move to progress view after saving
                renderSubView('progress-view');
            } catch (error) {
                console.error("Error saving assessment:", error);
                showMessageBox('평가 기록 저장 실패', '데이터베이스 저장 중 오류가 발생했습니다. 콘솔을 확인해주세요.', 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i data-lucide="save" class="w-5 h-5 mr-2"></i> 평가 결과 저장 및 진도 기록';
                lucide.createIcons();
            }
        }
        window.saveAssessment = saveAssessment;

        // --- Feature 2: Charting Assistant (in Charting View) ---

        function renderChartingView() {
            const view = document.getElementById('charting-view');
            view.innerHTML = `
                <div class="flex flex-col flex-1 p-4 overflow-y-auto">
                    <h3 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">✨ 간호 기록 초안 생성기</h3>
                    <p class="text-gray-600 mb-6">활력징후와 환자의 상태를 입력하면, 임상적 판단에 기반한 **간호 기록(Charting Note)** 초안을 생성해 드립니다.</p>

                    <div class="space-y-4 mb-8 p-6 bg-white rounded-xl shadow-lg border border-gray-100">
                        <div class="grid grid-cols-2 gap-4">
                            <label class="block">
                                <span class="text-gray-700 font-medium">체온 (T, °C)</span>
                                <input id="chart-t" type="number" step="0.1" placeholder="36.5" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                            </label>
                            <label class="block">
                                <span class="text-gray-700 font-medium">맥박 (P, 회/분)</span>
                                <input id="chart-p" type="number" placeholder="72" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                            </label>
                            <label class="block">
                                <span class="text-gray-700 font-medium">호흡 (R, 회/분)</span>
                                <input id="chart-r" type="number" placeholder="18" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                            </label>
                            <label class="block">
                                <span class="text-gray-700 font-medium">혈압 (BP, mmHg)</span>
                                <input id="chart-bp" type="text" placeholder="120/80" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                            </label>
                        </div>
                        
                        <label class="block pt-2">
                            <span class="text-gray-700 font-medium">환자 주요 증상 및 객관적/주관적 상태 (필수)</span>
                            <textarea id="chart-symptoms" rows="3" placeholder="예: '두통 호소', '식은땀 흘림', '의식 명료함' 등" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
                        </label>

                        <button onclick="generateChartingNote()" id="charting-btn" class="w-full flex items-center justify-center px-4 py-3 text-base font-bold rounded-xl text-white bg-indigo-600 hover:bg-indigo-700 transition-colors shadow-md mt-4">
                            <i data-lucide="bot" class="w-5 h-5 mr-2"></i> 기록 초안 생성
                        </button>
                    </div>

                    <h3 class="text-lg font-bold text-gray-700 mb-3">생성된 간호 기록 초안</h3>
                    <div id="charting-output" class="p-4 bg-gray-100 rounded-lg min-h-[150px] shadow-inner text-gray-700">
                        <p class="text-gray-500 italic text-sm">기록 초안을 생성하려면 위의 양식을 작성하고 버튼을 눌러주세요.</p>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }
        window.renderChartingView = renderChartingView;

        async function generateChartingNote() {
            const t = document.getElementById('chart-t').value;
            const p = document.getElementById('chart-p').value;
            const r = document.getElementById('chart-r').value;
            const bp = document.getElementById('chart-bp').value;
            const symptoms = document.getElementById('chart-symptoms').value;
            const output = document.getElementById('charting-output');
            const button = document.getElementById('charting-btn');

            if (!symptoms) {
                showMessageBox('입력 부족', '환자의 주요 증상 및 상태를 반드시 입력해야 합니다.', 'warning');
                return;
            }

            button.disabled = true;
            button.innerHTML = '<i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i> 초안 생성 중...';
            output.innerHTML = '<p class="text-gray-500 italic text-sm">Gemini가 전문적인 간호 기록 초안을 작성하고 있습니다...</p>';
            lucide.createIcons();

            const vts = `체온(T): ${t || '기록 없음'}°C, 맥박(P): ${p || '기록 없음'}회/분, 호흡(R): ${r || '기록 없음'}회/분, 혈압(BP): ${bp || '기록 없음'} mmHg`;

            const systemPrompt = "You are a professional registered nurse. Your task is to generate a concise, objective, and well-structured nursing note (Charting Note) based on the provided vital signs and patient symptoms. Use the SOAP (Subjective, Objective, Assessment, Plan) or DAR (Data, Action, Response) format, making it clear and clinically relevant. Use Korean for the final output. Do not include a time or date placeholder or your signature. Just provide the note content.";
            const userQuery = `다음 환자 데이터에 대해 간호 기록 초안을 작성해 주세요. 전문 간호사처럼 작성하고, 필요한 경우 후속 조치(Plan/Action)를 제시해주세요.\n\n활력징후: ${vts}\n주요 증상 및 상태: ${symptoms}`;

            try {
                const note = await fetchGeminiContent(userQuery, systemPrompt);
                output.innerHTML = `
                    <div class="text-sm bg-white p-4 rounded-lg border border-indigo-200 whitespace-pre-wrap font-mono">
                        ${note}
                    </div>
                `;
            } catch (error) {
                output.innerHTML = '<p class="text-red-500">기록 초안 생성 중 오류 발생: 잠시 후 다시 시도해 주세요.</p>';
            } finally {
                button.disabled = false;
                button.innerHTML = '<i data-lucide="bot" class="w-5 h-5 mr-2"></i> 기록 초안 생성';
                lucide.createIcons();
            }
        }
        window.generateChartingNote = generateChartingNote;


        // --- Utility & Progress View Logic (Firestore) ---

        function getSkillCollectionRef(db, appId, userId) {
            const collectionPath = `artifacts/${appId}/users/${userId}/nursing_progress`;
            return collection(db, collectionPath);
        }

        function showMessageBox(title, message, type) {
            const box = document.getElementById('message-box');
            const icon = document.getElementById('message-icon');
            const titleEl = document.getElementById('message-title');
            const messageEl = document.getElementById('message-message');
            const closeBtn = document.getElementById('message-close-btn');

            let bgColor, iconSvg;
            if (type === 'success') { bgColor = 'bg-green-500'; iconSvg = `<i data-lucide="check-circle" class="w-6 h-6"></i>`; } 
            else if (type === 'error') { bgColor = 'bg-red-500'; iconSvg = `<i data-lucide="alert-triangle" class="w-6 h-6"></i>`; } 
            else { bgColor = 'bg-blue-500'; iconSvg = `<i data-lucide="info" class="w-6 h-6"></i>`; }

            box.classList.remove('hidden', 'bg-green-500', 'bg-red-500', 'bg-blue-500');
            box.classList.add('flex', 'p-4', bgColor);
            icon.innerHTML = iconSvg;
            titleEl.textContent = title;
            messageEl.textContent = message;

            closeBtn.onclick = () => box.classList.add('hidden');
            lucide.createIcons();
        }
        window.showMessageBox = showMessageBox;

        let progressRecords = [];

        function setupDataListeners() {
            if (!window.currentUserId || !window.db) return;

            const db = getFirestore();
            const progressRef = getSkillCollectionRef(db, window.appId, window.currentUserId);
            
            // NOTE: orderBy is removed to prevent index errors. Data is sorted in memory.
            const q = query(progressRef);
            
            onSnapshot(q, (snapshot) => {
                progressRecords = [];
                snapshot.forEach((doc) => {
                    progressRecords.push({ id: doc.id, ...doc.data() });
                });
                // Sort data by timestamp in memory (descending)
                progressRecords.sort((a, b) => {
                    const timeA = a.timestamp ? a.timestamp.toDate().getTime() : 0;
                    const timeB = b.timestamp ? b.timestamp.toDate().getTime() : 0;
                    return timeB - timeA;
                });

                renderProgressView();
            }, (error) => {
                console.error("Error listening to progress data:", error);
                document.getElementById('progress-list').innerHTML = '<p class="text-red-500">데이터를 불러오는 중 오류가 발생했습니다.</p>';
            });
        }
        window.setupDataListeners = setupDataListeners;

        function renderProgressView() {
            const listEl = document.getElementById('progress-list');
            const totalScoreEl = document.getElementById('average-score');
            const progressChartEl = document.getElementById('overall-progress-chart');

            if (progressRecords.length === 0) {
                listEl.innerHTML = '<div class="p-6 text-center text-gray-500 bg-white rounded-xl shadow-sm">아직 저장된 학습 기록이 없습니다. 학습하고 자기 평가를 저장해 보세요!</div>';
                totalScoreEl.textContent = '0%';
                progressChartEl.style.width = '0%';
                return;
            }

            // Filter records for the specific skill '활력징후 측정 전체 술기'
            const vitalSignRecords = progressRecords.filter(r => r.skillId === 'vital-signs');
            
            if (vitalSignRecords.length === 0) {
                 listEl.innerHTML = '<div class="p-6 text-center text-gray-500 bg-white rounded-xl shadow-sm">아직 \'활력징후 측정\'에 대한 저장된 평가 기록이 없습니다.</div>';
                 totalScoreEl.textContent = '0%';
                 progressChartEl.style.width = '0%';
                 return;
            }

            const totalScoreSum = vitalSignRecords.reduce((sum, record) => sum + (record.score || 0), 0);
            const averageScore = totalScoreSum / vitalSignRecords.length;
            
            // Calculate overall progress based on the last recorded score (as a proxy for completion)
            const latestScore = vitalSignRecords[0].score || 0; // Highest score or latest score could be used
            const skillProgress = latestScore; // Use latest score for progress bar

            totalScoreEl.textContent = `${Math.round(averageScore)}%`;
            progressChartEl.style.width = `${Math.min(100, skillProgress)}%`;
            
            listEl.innerHTML = vitalSignRecords.map(record => {
                const date = record.timestamp ? new Date(record.timestamp.toDate()).toLocaleString('ko-KR') : '날짜 미상';
                const scoreColor = record.score >= 90 ? 'text-green-600' : record.score >= 70 ? 'text-yellow-600' : 'text-red-600';
                
                return `
                    <div class="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center border-l-4 ${record.score === 100 ? 'border-green-500' : 'border-indigo-400'}">
                        <div class="flex-1">
                            <p class="font-bold text-gray-800">${record.skillTitle || '술기 항목'}</p>
                            <p class="text-sm text-gray-500 mt-1">평가일: ${date}</p>
                            <p class="text-xs text-indigo-500 mt-1">${record.completedItems}/${record.totalItems} 항목 완료</p>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-extrabold ${scoreColor}">${record.score || 0}%</p>
                            <span class="text-xs text-gray-500">${record.isCompleted ? '숙련 완료' : '반복 학습 필요'}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // **수정된 부분: window.onload 대신 DOMContentLoaded 사용**
        // Initialize App: Show the welcome screen immediately when the HTML structure is loaded.
        document.addEventListener('DOMContentLoaded', () => {
            showView('welcome-view'); 
        });
    </script>
</head>
<body class="min-h-screen p-4 sm:p-6 pb-20">

    <!-- Message Box (Replacing alert()) -->
    <div id="message-box" class="fixed top-4 right-4 z-50 hidden items-center justify-between text-white p-4 rounded-lg shadow-xl" role="alert">
        <div class="flex items-center">
            <span id="message-icon" class="mr-3"></span>
            <div>
                <p id="message-title" class="font-bold"></p>
                <p id="message-message" class="text-sm"></p>
            </div>
        </div>
        <button id="message-close-btn" class="ml-4 opacity-90 hover:opacity-100">
            <i data-lucide="x" class="w-5 h-5"></i>
        </button>
    </div>

    <div class="container bg-white rounded-2xl shadow-2xl p-4 sm:p-8">
        <!-- Header (Updated to LAMP) -->
        <header class="mb-6 border-b pb-4 flex justify-between items-center">
            <h1 class="text-3xl font-extrabold text-indigo-800 flex items-center">
                <i data-lucide="lamp-ceiling" class="w-8 h-8 mr-2 text-indigo-500 fill-indigo-500"></i>
                LAMP
            </h1>
            <button id="back-to-list-btn" onclick="showView('skill-list-view')" class="hidden px-3 py-1 text-sm font-medium rounded-lg text-indigo-600 bg-indigo-100 hover:bg-indigo-200 transition-colors">
                <i data-lucide="arrow-left" class="w-4 h-4 inline mr-1"></i> 목록으로
            </button>
        </header>
        
        <div id="user-id-display" class="text-xs mb-4 p-1 bg-gray-100 rounded text-gray-600 break-words">사용자 ID: 인증 중...</div>

        <!-- Main Content Area -->
        <div id="app-container" class="min-h-[500px]">

<!-- 1. 환영 화면 (Welcome View) -->
<div id="welcome-view"
     class="app-view-main flex flex-col hidden items-center justify-center text-center min-h-screen p-4">
  <div class="p-8 bg-indigo-50 rounded-2xl shadow-xl max-w-sm w-full">
    <!-- 아이콘 -->
    <i data-lucide="graduation-cap" class="w-16 h-16 text-indigo-600 mx-auto mb-4"></i>
    
    <!-- 제목 -->
    <h2 class="text-4xl font-extrabold text-indigo-800 mb-2">LAMP</h2>
    
    <!-- 설명 -->
    <p class="text-xl font-medium text-gray-700 mb-6">
      <span class="font-mono text-indigo-600">(L)</span>earning 
      <span class="font-mono text-indigo-600">(A)</span>ssistant for 
      <span class="font-mono text-indigo-600">(M)</span>edical 
      <span class="font-mono text-indigo-600">(P)</span>ractice
    </p>

    <p class="text-gray-600 italic mb-8">
      "간호 지식의 빛을 밝히는 학습 도우미"
    </p>

    <!-- 학습 시작하기 버튼 -->
    <button onclick="showView('skill-list-view')" 
            class="start-button flex items-center justify-center mx-auto px-8 py-4 text-lg font-bold rounded-full text-white bg-indigo-600 hover:bg-indigo-700 transition-colors shadow-lg">
      <i data-lucide="play" class="w-6 h-6 mr-2 fill-white"></i> 학습 시작하기
    </button>

    <!-- 🔽 로그인 폼 추가 -->
    <div class="mt-8 text-left">
      <h3 class="text-indigo-700 font-semibold text-lg mb-3">로그인</h3>
      <form onsubmit="handleLogin(event)" class="space-y-4">
        <input type="email" id="email" placeholder="이메일" required
               class="w-full p-3 border border-indigo-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-400" />
        <input type="password" id="password" placeholder="비밀번호" required
               class="w-full p-3 border border-indigo-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-400" />
        <button type="submit"
                class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-xl hover:bg-indigo-700 transition-colors shadow-md">
          로그인
        </button>
      </form>
    </div>
  </div>
</div>

<script>
  // Lucide 아이콘 활성화
  lucide.createIcons();

  // 로그인 예시 함수
  function handleLogin(event) {
    event.preventDefault();
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    alert(`로그인 시도: ${email}`);
    // 실제 로그인 로직 (API 요청 등) 추가 가능
  }

  // 화면 전환 함수
  function showView(viewId) {
    document.querySelectorAll('.app-view-main').forEach(v => v.classList.add('hidden'));
    document.getElementById(viewId).classList.remove('hidden');
  }
</script>


            <!-- 2. 술기 목록 뷰 (Skill List View) -->
            <div id="skill-list-view" class="app-view-main flex-col hidden">
                <h2 class="text-2xl font-bold text-gray-700 mb-6 border-b pb-2">핵심 기본간호술기 18가지 목록</h2>
                <div id="skill-list-container" class="space-y-3">
                    <!-- Skill list rendered by JS -->
                </div>
            </div>

            <!-- 3. 술기 상세/학습 뷰 (Procedure Detail View) -->
            <div id="procedure-detail-view" class="app-view-main flex-col hidden">
                
                <!-- Shared Title -->
                <h2 class="text-2xl font-bold text-gray-700 mb-4 border-b pb-2 flex items-center">
                    <span id="procedure-title">활력징후 측정</span> 
                    <span id="procedure-title-step-count" class="text-sm font-medium text-gray-500 ml-3"></span>
                </h2>

                <!-- Sub Navigation Tabs (New structure) -->
                <nav class="fixed bottom-0 left-0 right-0 bg-white border-t sm:relative sm:border-t-0 sm:flex sm:justify-center sm:mb-8 z-10">
                    <div class="flex justify-around w-full sm:w-auto sm:space-x-2 p-2 sm:p-0 text-sm font-medium">
                        <!-- New 1. 개요 -->
                        <button class="nav-link flex-1 sm:flex-initial flex flex-col items-center p-2 rounded-xl text-indigo-700 hover:bg-indigo-100 transition-colors" data-view="overview-view" onclick="renderSubView('overview-view')">
                            <i data-lucide="layout-grid" class="w-6 h-6"></i>
                            <span class="text-xs mt-1">개요</span>
                        </button>
                        <!-- 2. 술기 영상 -->
                        <button class="nav-link flex-1 sm:flex-initial flex flex-col items-center p-2 rounded-xl text-indigo-700 hover:bg-indigo-100 transition-colors" data-view="procedure-learning-view" onclick="renderSubView('procedure-learning-view')">
                            <i data-lucide="book-open-text" class="w-6 h-6"></i>
                            <span class="text-xs mt-1">술기 영상</span>
                        </button>
                        <!-- 3. 체크리스트 -->
                        <button class="nav-link flex-1 sm:flex-initial flex flex-col items-center p-2 rounded-xl text-indigo-700 hover:bg-indigo-100 transition-colors" data-view="checklist-view" onclick="renderSubView('checklist-view')">
                            <i data-lucide="clipboard-check" class="w-6 h-6"></i>
                            <span class="text-xs mt-1">체크리스트</span>
                        </button>
                        <!-- 4. 기록 초안 (Gemini) -->
                        <button class="nav-link flex-1 sm:flex-initial flex flex-col items-center p-2 rounded-xl text-indigo-700 hover:bg-indigo-100 transition-colors" data-view="charting-view" onclick="renderSubView('charting-view')">
                            <i data-lucide="file-text" class="w-6 h-6"></i>
                            <span class="text-xs mt-1">기록 초안 ✨</span>
                        </button>
                        <!-- 5. 학습 진도 -->
                        <button class="nav-link flex-1 sm:flex-initial flex flex-col items-center p-2 rounded-xl text-indigo-700 hover:bg-indigo-100 transition-colors" data-view="progress-view" onclick="renderSubView('progress-view')">
                            <i data-lucide="bar-chart-3" class="w-6 h-6"></i>
                            <span class="text-xs mt-1">학습 진도</span>
                        </button>
                        <!-- 6. 커뮤니티 -->
                        <button class="nav-link flex-1 sm:flex-initial flex flex-col items-center p-2 rounded-xl text-indigo-700 hover:bg-indigo-100 transition-colors" data-view="community-view" onclick="renderSubView('community-view')">
                            <i data-lucide="users" class="w-6 h-6"></i>
                            <span class="text-xs mt-1">커뮤니티</span>
                        </button>
                    </div>
                </nav>

                <!-- Sub View Containers -->
                <div id="procedure-views-container" class="flex-1 mt-4 sm:mt-0">
                    
                    <!-- 1. 개요 뷰 (Overview View) -->
                    <div id="overview-view" class="app-view-sub flex-col hidden min-h-[400px]">
                        <!-- Content rendered by JS (renderOverviewView) -->
                    </div>
                    
                    <!-- 2. 술기 영상 뷰 (Procedure Learning View) -->
                    <div id="procedure-learning-view" class="app-view-sub flex-col hidden min-h-[400px]">
                        <!-- Content rendered by JS (renderProcedureLearningView) -->
                    </div>
                    
                    <!-- 3. 체크리스트 뷰 (Checklist View) -->
                    <div id="checklist-view" class="app-view-sub flex-col hidden min-h-[400px]">
                        <!-- Content rendered by JS (renderChecklistView) -->
                    </div>

                    <!-- 4. 기록 초안 뷰 (Charting View) -->
                    <div id="charting-view" class="app-view-sub flex-col hidden min-h-[400px]">
                        <!-- Content rendered by JS (renderChartingView) -->
                    </div>

                    <!-- 5. 학습 진도 뷰 (Progress View) -->
                    <div id="progress-view" class="app-view-sub flex-col hidden min-h-[400px]">
                        <h3 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">활력징후 측정 학습 진도</h3>

                        <div class="bg-indigo-50 p-6 rounded-xl shadow-inner mb-6">
                            <p class="text-lg font-semibold text-indigo-700 mb-2">총 평가 평균 점수</p>
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-indigo-600 font-medium">평균 점수:</span>
                                <span id="average-score" class="text-xl font-bold text-indigo-800">0%</span>
                            </div>
                            <!-- Progress Bar -->
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div id="overall-progress-chart" class="progress-bar-fill h-3 bg-indigo-500 rounded-full" style="width: 0%"></div>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">최근 저장된 평가 점수를 기반으로 진도가 표시됩니다.</p>
                        </div>

                        <!-- Progress Records List -->
                        <h3 class="text-xl font-bold text-gray-700 mb-4">최근 평가 기록</h3>
                        <div id="progress-list" class="space-y-3">
                            <div class="p-6 text-center text-gray-500 bg-white rounded-xl shadow-sm">데이터 로드 중...</div>
                        </div>
                    </div>

                    <!-- 6. 커뮤니티 뷰 (Community View) - Mockup -->
                    <div id="community-view" class="app-view-sub flex-col hidden items-center justify-center p-8 text-center min-h-[400px]">
                        <i data-lucide="message-square-text" class="w-16 h-16 text-blue-500 mb-4"></i>
                        <h2 class="text-2xl font-bold text-gray-700 mb-2">협력적 학습 커뮤니티 (개발 예정)</h2>
                        <p class="text-gray-500">질문, 정보 공유, 추천 콘텐츠 등록 등 상호작용을 촉진하는 소셜 기능이 추가될 예정입니다.</p>
                        <div class="mt-6 w-full max-w-sm p-4 bg-blue-50 rounded-lg border border-blue-300">
                            <p class="font-medium text-sm text-blue-700">질의응답 게시판 목업 준비 중...</p>
                        </div>
                    </div>

                </div>

                <!-- Step Navigation (Only visible for Procedure Learning Tab) -->
                <div id="step-navigation" class="flex justify-center items-center py-4 border-t hidden">
                    <button id="prev-step-btn" class="flex items-center justify-center px-4 py-2 text-sm font-medium rounded-lg text-white ${currentStep > 1 ? 'bg-indigo-500 hover:bg-indigo-600' : 'bg-gray-300 cursor-not-allowed'}" 
                            ${currentStep === 1 ? 'disabled' : ''} onclick="changeStep(-1)">
                        <i data-lucide="chevron-left" class="w-5 h-5 mr-1"></i> 이전 단계
                    </button>
                    <span class="text-indigo-800 font-semibold mx-4">${currentStep} / ${VITAL_SIGN_STEPS.length}</span>
                    <button id="next-step-btn" class="flex items-center justify-center px-4 py-2 text-sm font-medium rounded-lg text-white ${currentStep < VITAL_SIGN_STEPS.length ? 'bg-indigo-500 hover:bg-indigo-600' : 'bg-gray-300 cursor-not-allowed'}" 
                            ${currentStep === VITAL_SIGN_STEPS.length ? 'disabled' : ''} onclick="changeStep(1)">
                        다음 단계 <i data-lucide="chevron-right" class="w-5 h-5 ml-1"></i>
                    </button>
                </div>

            </div>
        </div>

        <!-- Footer for padding on mobile -->
        <footer class="h-16 sm:h-0"></footer>
    </div>
</body>
</html>
