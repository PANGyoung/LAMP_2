<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•µì‹¬ ê°„í˜¸ìˆ ê¸° í•™ìŠµ í”Œë«í¼ (LAMP)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .skill-item {
            transition: all 0.3s ease;
        }
        .skill-item:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }
        .progress-bar-fill {
            transition: width 1s ease-in-out;
        }
        /* Style for the button on the welcome screen */
        .start-button {
            animation: pulse-shadow 2s infinite;
        }
        @keyframes pulse-shadow {
            0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(79, 70, 229, 0); }
            100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); }
        }
        /* Rationale visibility transition */
        .rationale-container {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out;
        }
        .rationale-container.visible {
            max-height: 200px; /* Sufficient height for content */
            padding-bottom: 0.75rem; /* pb-3 */
            padding-top: 0.5rem; /* pt-2 */
        }

    </style>

    <!-- Firebase SDK Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let currentUserId = null;

        if (Object.keys(firebaseConfig).length === 0) {
            console.error("Firebase configuration is missing.");
            document.getElementById('app-container').innerHTML = '<div class="p-8 text-center text-red-600 bg-red-100 rounded-lg">Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. í™˜ê²½ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</div>';
        } else {
            // Initialize Firebase only if config exists
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            setLogLevel('debug');

            // Global variables for App Logic
            window.db = db;
            window.auth = auth;
            window.appId = appId;
            window.currentUserId = currentUserId;

            // Sign In and Auth State Handling
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    window.currentUserId = currentUserId;
                    console.log("Authenticated with UID:", currentUserId);
                } else {
                    console.log("No user signed in. Attempting anonymous sign-in...");
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Authentication Error:", error);
                    }
                }
                document.getElementById('user-id-display').textContent = 'ì‚¬ìš©ì ID: ' + (currentUserId || 'ë¡œê·¸ì¸ ì¤‘...');
                window.setupDataListeners(); // Call setup function once authenticated
            });
        }
    </script>

    <!-- Application Logic Script -->
    <script type="module">
        import { getFirestore, onSnapshot, collection, query, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GEMINI API Setup ---
        const API_KEY = ""; // Leave as-is for Canvas environment
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        const VIDEO_URL = "http://yswpub3.synology.me/smspdf/revision2023_song_fundamentalsofnursing_video/2023_QR_11.mp4"; // User Request 2

        /**
         * Calls the Gemini API with exponential backoff.
         */
        async function fetchGeminiContent(userQuery, systemPrompt, maxRetries = 3) {
            const apiKey = API_KEY;
            const url = `${API_URL}?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && attempt < maxRetries - 1) {
                            const delay = Math.pow(2, attempt) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue; // Retry
                        }
                        throw new Error(`API call failed with status: ${response.status}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (text) {
                        return text;
                    } else {
                        throw new Error("API response text is empty or malformed.");
                    }
                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error);
                    if (attempt === maxRetries - 1) throw error; 
                    const delay = Math.pow(2, attempt) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // --- SKILL DATA ---
        const CORE_SKILLS = [
            { name: "í™œë ¥ì§•í›„ ì¸¡ì •", difficulty: "í•˜", linkId: "vital-signs", emoji: "ğŸ©º" },
            { name: "ê²½êµ¬íˆ¬ì•½", difficulty: "í•˜", linkId: "mock", emoji: "ğŸ’Š" },
            { name: "ê·¼ìœ¡ì£¼ì‚¬", difficulty: "ì¤‘", linkId: "mock", emoji: "ğŸ’‰" },
            { name: "í”¼í•˜ì£¼ì‚¬(ê°„ì´ í˜ˆë‹¹ê²€ì‚¬ í¬í•¨)", difficulty: "ì¤‘", linkId: "mock", emoji: "ğŸ©¸" },
            { name: "í”¼ë‚´ì£¼ì‚¬(ì „ì™„ì˜ ë‚´ì¸¡ë©´)", difficulty: "ìƒ", linkId: "mock", emoji: "ğŸ§ª" },
            { name: "ì •ë§¥ìˆ˜ì•¡ ì£¼ì…(Infusionpump í˜¹ì€ syringepump ì‚¬ìš© í¬í•¨)", difficulty: "ìƒ", linkId: "mock", emoji: "ğŸ’§" },
            { name: "ìˆ˜í˜ˆìš”ë²•", difficulty: "ìƒ", linkId: "mock", emoji: "â¤ï¸" },
            { name: "ê°„í—ì  ìœ„ê´€ì˜ì–‘", difficulty: "ì¤‘", linkId: "mock", emoji: "ğŸ¥£" },
            { name: "ë‹¨ìˆœë„ë‡¨(Straight catheterization)", difficulty: "ì¤‘", linkId: "mock", emoji: "ğŸš½" },
            { name: "ìœ ì¹˜ë„ë‡¨(Indwelling catheterization)", difficulty: "ìƒ", linkId: "mock", emoji: "ğŸ’¦" },
            { name: "ë°°ì¶œê´€ì¥", difficulty: "ì¤‘", linkId: "mock", emoji: "ğŸ‘" },
            { name: "ë§ì´ˆì‚°ì†Œí¬í™”ë„(Pulse oximeter) ì¸¡ì •ê³¼ ì‹¬ì „ë„ ëª¨ë‹ˆí„°(EKG monitor) ì ìš©", difficulty: "í•˜", linkId: "mock", emoji: "ğŸ“Ÿ" },
            { name: "ë¹„ê°•ìºë‰¼ë¼ë¥¼ ì´ìš©í•œ ì‚°ì†Œìš”ë²•", difficulty: "í•˜", linkId: "mock", emoji: "ğŸŒ¬ï¸" },
            { name: "í¡ì¸(Suction)", difficulty: "ìƒ", linkId: "mock", emoji: "ğŸ˜·" },
            { name: "ê¸°ë³¸ ì‹¬íì†Œìƒìˆ  ë° ì œì„¸ë™ê¸° ì ìš©", difficulty: "ì¤‘", linkId: "mock", emoji: "âš¡" },
            { name: "í†µì¦ê´€ë¦¬", difficulty: "ì¤‘", linkId: "mock", emoji: "ğŸ©¹" },
            { name: "ìš•ì°½ê´€ë¦¬ ë° ë‚™ìƒì˜ˆë°©ê°„í˜¸", difficulty: "í•˜", linkId: "mock", emoji: "ğŸ›ï¸" },
            { name: "ë°°ì•¡ê´€ ê´€ë¦¬(JPë˜ëŠ” Hemovac)", difficulty: "ì¤‘", linkId: "mock", emoji: "ğŸ—‘ï¸" }
        ];

        // --- VITAL SIGN LEARNING STEPS (Used for Procedure Learning Tab Navigation) ---
        const VITAL_SIGN_STEPS = [
            { id: 1, title: "ì¤€ë¹„ ë° í™˜ì í™•ì¸", procedure: "ë¬¼ê³¼ ë¹„ëˆ„ ë˜ëŠ” ì•Œì½”ì˜¬ ê¸°ë°˜ ì† ì†Œë…ì œë¥¼ ì´ìš©í•˜ì—¬ ì† ìœ„ìƒì„ ì‹¤ì‹œí•˜ê³ , í™˜ìì—ê²Œ ì²´ì˜¨, ë§¥ë°•, í˜¸í¡, í˜ˆì•• ì¸¡ì •ì„ ì„¤ëª…í•œ í›„ ë™ì˜ë¥¼ êµ¬í•˜ê³  í•„ìš”í•œ ì¥ë¹„ë¥¼ ì¤€ë¹„í•œë‹¤.", terms: ["Hand Hygiene", "Informed Consent"] },
            { id: 2, title: "ì²´ì˜¨ ì¸¡ì • (Temperature)", procedure: "êµ¬ê°•, ì•¡ì™€, ê³ ë§‰, ë˜ëŠ” ì§ì¥ ì²´ì˜¨ ì¤‘ ì ì ˆí•œ ë°©ë²•ì„ ì„ íƒí•˜ê³  ì •í™•í•œ ì¸¡ì • ë¶€ìœ„ì— ì²´ì˜¨ê³„ë¥¼ ìœ„ì¹˜ì‹œí‚¨ë‹¤. ê²°ê³¼ëŠ” ì¦‰ì‹œ í™•ì¸í•˜ê³  ê¸°ë¡í•œë‹¤.", terms: ["Oral Temp", "Axillary Temp", "Tympanic Temp"] },
            { id: 3, title: "ë§¥ë°• ì¸¡ì • (Pulse)", procedure: "ìš”ê³¨ë™ë§¥(Radial artery)ì„ ì´‰ì§€í•˜ì—¬ ë§¥ë°•ì˜ ê·œì¹™ì„±ê³¼ ê°•ë„ë¥¼ í™•ì¸í•˜ê³ , 1ë¶„ ë™ì•ˆ ì¸¡ì •í•œë‹¤. ë§¥ë°•ìˆ˜ê°€ ë¶ˆê·œì¹™í•  ê²½ìš° ì‹¬ì²¨ ë§¥ë°•ì„ ì¸¡ì •í•œë‹¤.", terms: ["Radial Pulse", "Apical Pulse", "Tachycardia", "Bradycardia"] },
            { id: 4, title: "í˜¸í¡ ì¸¡ì • (Respiration)", procedure: "ë§¥ë°• ì¸¡ì • í›„ ì†ì„ ë–¼ì§€ ì•Šê³  í™˜ìì—ê²Œ ì•Œë¦¬ì§€ ì•Šì€ ìƒíƒœë¡œ ê°€ìŠ´ì˜ ì˜¤ë¥´ë‚´ë¦¼ì„ ê´€ì°°í•˜ë©° 1ë¶„ ë™ì•ˆ ì¸¡ì •í•œë‹¤. ê¹Šì´ì™€ ë¦¬ë“¬ë„ í•¨ê»˜ í™•ì¸í•œë‹¤.", terms: ["Dyspnea", "Tachypnea", "Bradypnea"] },
            { id: 5, title: "í˜ˆì•• ì¸¡ì • (Blood Pressure)", procedure: "ëŒ€ìƒìë¥¼ ì•ˆì •ì‹œí‚¤ê³  íŒ”ì„ ì‹¬ì¥ ë†’ì´ì— ë‘”ë‹¤. ì»¤í”„ë¥¼ ì •í™•íˆ ê°ê³  ì²­ì§„ê¸°ë¡œ ì‹¬ìŒ(Korotkoff sound)ì„ ë“¤ìœ¼ë©´ì„œ ìˆ˜ì¶•ê¸°/ì´ì™„ê¸° í˜ˆì••ì„ ì¸¡ì •í•œë‹¤. ì¸¡ì • í›„ ì»¤í”„ì˜ ê³µê¸°ë¥¼ ì™„ì „íˆ ì œê±°í•œë‹¤.", terms: ["Systolic BP", "Diastolic BP", "Hypertension", "Hypotension"] },
            { id: 6, title: "ê¸°ë¡ ë° ë§ˆë¬´ë¦¬", procedure: "ì¸¡ì •ëœ í™œë ¥ì§•í›„ ê²°ê³¼ë¥¼ ì¦‰ì‹œ ê¸°ë¡í•˜ê³ , ì‚¬ìš©í•œ ì¥ë¹„ë¥¼ ì •ë¦¬í•˜ë©° ì† ìœ„ìƒìœ¼ë¡œ ë§ˆë¬´ë¦¬í•œë‹¤. íŠ¹ì´ì‚¬í•­ì„ í™˜ìì—ê²Œ ì•Œë¦¬ê³  í•„ìš”í•œ ì¶”ê°€ ì¡°ì¹˜ë¥¼ ì·¨í•œë‹¤.", terms: ["Charting", "Baseline Data"] }
        ];
        
        // --- FULL CHECKLIST DATA (Includes Rationale for User Request 3) ---
        const VITAL_SIGN_CHECKLIST_DATA = [
            { item: "ë¬¼ê³¼ ë¹„ëˆ„ë¡œ ì†ìœ„ìƒì„ ì‹¤ì‹œí•œë‹¤.", rationale: "ë¯¸ìƒë¬¼ ì „íŒŒë¥¼ ë°©ì§€í•¨." }, // User request 3
            { item: "í•„ìš”í•œ ë¬¼í’ˆì„ ì¤€ë¹„í•˜ê³ , ì‘ë™ì—¬ë¶€ë¥¼ í™•ì¸í•œë‹¤.(ì²­ì§„ê¸°, ì²´ì˜¨ê³„, í˜ˆì••ê³„)", rationale: "ì •í™•í•œ ì¸¡ì •ì„ ë³´ì¥í•˜ê³  ìˆ ê¸° ì‹œê°„ì„ ë‹¨ì¶•í•©ë‹ˆë‹¤." },
            { item: "ì¤€ë¹„í•œ ë¬¼í’ˆì„ ê°€ì§€ê³  ëŒ€ìƒìì—ê²Œ ê°€ì„œ ê°„í˜¸ì‚¬ ìì‹ ì„ ì†Œê°œí•œë‹¤.", rationale: "í™˜ìì˜ ë¶ˆì•ˆì„ ê°ì†Œì‹œí‚¤ê³  ë¼í¬(Rapport)ë¥¼ í˜•ì„±í•©ë‹ˆë‹¤." },
            { item: "ì†ì†Œë…ì œë¡œ ì†ìœ„ìƒì„ ì‹¤ì‹œí•œë‹¤.", rationale: "ê°ì—¼ ê´€ë¦¬ë¥¼ ìœ„í•œ ì¶”ê°€ì ì¸ ì˜ˆë°© ì¡°ì¹˜ì…ë‹ˆë‹¤." },
            { item: "ëŒ€ìƒìì˜ ì´ë¦„ì„ ê°œë°©í˜•ìœ¼ë¡œ ì§ˆë¬¸í•˜ì—¬ ëŒ€ìƒìë¥¼ í™•ì¸í•˜ê³ , ì…ì›íŒ”ì°Œì™€ í™˜ìë¦¬ìŠ¤íŠ¸(ë˜ëŠ” ì²˜ë°©ì§€)ë¥¼ ëŒ€ì¡°í•˜ì—¬ ëŒ€ìƒì(ì´ë¦„, ë“±ë¡ë²ˆí˜¸)ë¥¼ í™•ì¸í•œë‹¤.", rationale: "ì•ˆì „ì„ ìœ„í•´ íˆ¬ì•½ ë° ì²˜ì¹˜ ì „ ì •í™•í•œ ëŒ€ìƒì í™•ì¸ì€ í•„ìˆ˜ì…ë‹ˆë‹¤. (ê°œë°©í˜• ì§ˆë¬¸)" },
            { item: "ëŒ€ìƒìì—ê²Œ ì²´ì˜¨, ë§¥ë°•, í˜¸í¡, í˜ˆì••ì„ ì¸¡ì •í•˜ëŠ” ëª©ì ê³¼ ì ˆì°¨ë¥¼ ì„¤ëª…í•œë‹¤.", rationale: "í™˜ìì˜ í˜‘ì¡°ë¥¼ ì–»ê³ , ë¶ˆì•ˆì„ ì™„í™”í•˜ë©°, ì•Œ ê¶Œë¦¬ë¥¼ ì¶©ì¡±ì‹œí‚µë‹ˆë‹¤." },
            { item: "[ì•¡ì™€ ì²´ì˜¨ê³„] ì „ìì²´ì˜¨ê³„ë¥¼ êº¼ë‚´ì–´ ëë¶€ë¶„ì„ ì†Œë…ì†œìœ¼ë¡œ ë‹¦ì€ í›„ ê²¨ë“œë‘ì´ ì¤‘ì•™ì— ì‚½ì…í•˜ì—¬ ì²´ì˜¨ê³„ê°€ ë¹ ì§€ì§€ ì•Šë„ë¡ ì§€ì§€í•œë‹¤.", rationale: "ì²´ì˜¨ê³„ì˜ ì •í™•í•œ ì†Œë…ê³¼ ì¸¡ì • ë¶€ìœ„ì˜ ì •í™•í•œ ìœ„ì¹˜ëŠ” ì •í™•í•œ ì²´ì˜¨ ì¸¡ì •ì„ ìœ„í•´ ì¤‘ìš”í•©ë‹ˆë‹¤." },
            { item: "[ì•¡ì™€ ì²´ì˜¨ê³„] ëŒ€ìƒìì—ê²Œ ì²´ì˜¨ì´ ì¸¡ì •ë  ë•Œê¹Œì§€ ì²´ì˜¨ê³„ê°€ ìœ ì§€ë˜ë„ë¡ ì„¤ëª…í•œë‹¤.", rationale: "ì¸¡ì • ì‹œê°„ ë™ì•ˆ ì›€ì§ì„ì„ ìµœì†Œí™”í•˜ì—¬ ì˜¤ë¥˜ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤." },
            { item: "[ê³ ë§‰ì²´ì˜¨ê³„] ìš©ê¸°ì—ì„œ íƒì¹¨ ë®ê°œë¥¼ êº¼ë‚¸ í›„ íƒì¹¨ ë®ê°œë¥¼ ê³ ë§‰ì²´ì˜¨ê³„ì— ë®ëŠ”ë‹¤.", rationale: "êµì°¨ ê°ì—¼ì„ ì˜ˆë°©í•˜ê³  ì¸¡ì •ì˜ ì •í™•ì„±ì„ ë†’ì…ë‹ˆë‹¤." },
            { item: "[ê³ ë§‰ì²´ì˜¨ê³„] ëŒ€ìƒìì˜ ë¨¸ë¦¬ë¥¼ í•œ ìª½ìœ¼ë¡œ ëŒë ¤ ì²´ì˜¨ì„ ì¸¡ì •í•  ê·€ë¥¼ ë…¸ì¶œì‹œí‚¨ í›„ ê·“ë°”í€´ë¥¼(ì„±ì¸ì˜ ê·“ë°”í€´ëŠ” í›„ìƒë°©ìœ¼ë¡œ ì†Œì•„ëŠ” í›„í•˜ë°©ìœ¼ë¡œ) ë‹¹ê¸´ ë‹¤ìŒ íƒì¹¨ì„ ë¶€ë“œëŸ½ê²Œ ì™¸ì´ë„ë¡œ ì‚½ì…í•˜ì—¬ ì²´ì˜¨ì„ ì¸¡ì •í•œë‹¤.", rationale: "ê³ ë§‰ì²´ì˜¨ê³„ì˜ íƒì¹¨ì„ ê³ ë§‰ìœ¼ë¡œ í–¥í•˜ê²Œ í•˜ì—¬ ì •í™•í•œ ì¤‘ì‹¬ì²´ì˜¨ì„ ì¸¡ì •í•˜ê¸° ìœ„í•¨ì…ë‹ˆë‹¤." },
            { item: "[ê³ ë§‰ì²´ì˜¨ê³„] íƒì¹¨ ë®ê°œë¥¼ ì œê±° í•œ í›„ì— ì²´ì˜¨ì„ ë©”ëª¨í•œë‹¤.", rationale: "ì‚¬ìš© í›„ ì¦‰ì‹œ ë®ê°œë¥¼ ì œê±°í•˜ì—¬ ì˜¤ì—¼ëœ ìƒíƒœë¥¼ ë°©ì§€í•©ë‹ˆë‹¤." },
            { item: "ëŒ€ìƒìì˜ íŒ”ì„ í¸í•œ ìì„¸ë¡œ ë†“ê³ , ëŒ€ìƒìì˜ ì´ë¶ˆì„ ë‚´ë ¤ ê°€ìŠ´ì´ ë³´ì´ë„ë¡ í•œë‹¤.", rationale: "í˜¸í¡ ì¸¡ì •ì„ ìš©ì´í•˜ê²Œ í•˜ê³  í™˜ìì˜ í¸ì•ˆí•¨ì„ ìœ ì§€í•˜ê¸° ìœ„í•¨ì…ë‹ˆë‹¤." },
            { item: "ì†ê°€ë½ìœ¼ë¡œ ìš”ê³¨ë™ë§¥ì„ ì°¾ì•„ì„œ ê·¸ ìœ„ì— ë†“ê³ , ë§¥ë°• ë¶€ìœ„ë¥¼ í™•ì¸í•œ í›„, ë§¥ë°•ì„ ì¸¡ì •í•œë‹¤. (ì²˜ìŒ ì…ì› ì‹œ) 1ë¶„ê°„ ë§¥ë°•ìˆ˜ë¥¼ ì¸¡ì •í•œë‹¤. (ì…ì› ì¤‘ ê·œì¹™ì ì„ì„ í™•ì¸í•œ í›„) 30ì´ˆ ë™ì•ˆ ë§¥ë°•ìˆ˜ë¥¼ ì¸¡ì •í•œ í›„ 2ë°°ë¥¼ í•œë‹¤.", rationale: "ì •í™•í•œ ë§¥ë°•ìˆ˜, ë¦¬ë“¬, ê°•ë„ë¥¼ íŒŒì•…í•˜ê³ , ë¶ˆê·œì¹™í•  ê²½ìš° ì˜¤ì°¨ë¥¼ ì¤„ì´ê¸° ìœ„í•´ 1ë¶„ ì „ì²´ë¥¼ ì¸¡ì •í•´ì•¼ í•©ë‹ˆë‹¤." },
            { item: "ë§¥ë°•ì„ ì¸¡ì •í•œ í›„ ë™ë§¥ì— ì†ì„ ê·¸ëŒ€ë¡œ ëŒ„ ì±„ë¡œ í˜¸í¡ì„ ì¸¡ì •í•œë‹¤. (ì²˜ìŒ ì…ì› ì‹œ) 1ë¶„ê°„ í˜¸í¡ìˆ˜ë¥¼ ì¸¡ì •í•œë‹¤. (ì…ì› ì¤‘) 30ì´ˆ ë™ì•ˆ í˜¸í¡ìˆ˜ë¥¼ ì¸¡ì •í•œ í›„ 2ë°°ë¥¼ í•œë‹¤.", rationale: "í˜¸í¡ì€ ì˜ì‹ì ì¸ ì¡°ì ˆì´ ê°€ëŠ¥í•˜ë¯€ë¡œ, í™˜ìê°€ í˜¸í¡ì„ ì˜ì‹í•˜ì§€ ì•Šë„ë¡ ë§¥ë°• ì¸¡ì • ì§í›„ ì¸¡ì •í•©ë‹ˆë‹¤." },
            { item: "ì²´ì˜¨ì´ ì¸¡ì •ë˜ë©´ ì²´ì˜¨ê³„ë¥¼ ë¹¼ê³ , ì†Œë…ì†œìœ¼ë¡œ ë‹¦ì€ í›„ ì²´ì˜¨ê³„ì˜ ì „ì›ì„ ë„ê³  ìš©ê¸°ì— ë„£ëŠ”ë‹¤.", rationale: "ì¥ë¹„ë¥¼ ì²­ê²°í•˜ê²Œ ìœ ì§€í•˜ê³  ì „ë ¥ ì†Œë¹„ë¥¼ ì¤„ì´ê¸° ìœ„í•¨ì…ë‹ˆë‹¤." },
            { item: "ì¸¡ì •ëœ ë§¥ë°•ê³¼ í˜¸í¡, ì²´ì˜¨ì„ ë©”ëª¨í•œë‹¤.", rationale: "ì˜¤ë¥˜ë¥¼ ë°©ì§€í•˜ê³  ê°„í˜¸ ê¸°ë¡ ì „ê¹Œì§€ ë°ì´í„°ë¥¼ ì„ì‹œë¡œ ë³´ì¡´í•©ë‹ˆë‹¤." },
            { item: "ëŒ€ìƒìê°€ í¸ì•ˆí•œ ìì„¸ë¥¼ ì·¨í•˜ê²Œ í•œ í›„, ëŒ€ìƒìì˜ íŒ”ì„ ì‹¬ì¥ê³¼ ê°™ì€ ë†’ì´ë¡œ ë†“ê³  íŒ”ì„ ë…¸ì¶œì‹œí‚¨ë‹¤.", rationale: "ì •í™•í•œ í˜ˆì•• ì¸¡ì •ì„ ìœ„í•´ ì»¤í”„ ìœ„ì¹˜ê°€ ì‹¬ì¥ ë†’ì´ì™€ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤." },
            { item: "íŒ”ì˜¤ê¸ˆ ìƒì™„ë™ë§¥ 2~3cmìœ„ì— ì»¤í”„ì˜ bulbì— ì—°ê²°ëœ ì¤„ì´ ìƒì™„ë™ë§¥ê³¼ í‰í–‰ì´ ë˜ê²Œ ë†“ì´ë„ë¡ í•˜ê³  ì†ê°€ë½ í•˜ë‚˜ê°€ ë“¤ì–´ê°ˆ ì •ë„ì˜ ì—¬ìœ ë¥¼ ì£¼ê³  ê°ëŠ”ë‹¤.", rationale: "ì»¤í”„ì˜ ë¶€ì ì ˆí•œ ìœ„ì¹˜ëŠ” ì˜¤ì°¨ë¥¼ ìœ ë°œí•˜ë©°, ì ì ˆí•œ ë°€ì°©ì€ ì••ë ¥ì„ ì •í™•í•˜ê²Œ ì „ë‹¬í•©ë‹ˆë‹¤." },
            { item: "ì°¸ê³ : í˜ˆì•• ì´ˆê¸° ì¸¡ì •ì„ ìœ„í•´ ìƒì™„ë™ë§¥ì„ ì´‰ì§€í•˜ì—¬ ë§¥ë°• ì†Œì‹¤ ì§€ì ì„ í™•ì¸í•œë‹¤. (30mmHg ë” ì˜¬ë¦¼)", rationale: "ì²­ì§„ì„ ì‹œì‘í•  ì••ë ¥ì„ ê²°ì •í•˜ì—¬ ì²­ì§„ìƒì˜ ì˜¤ì°¨(Auscultatory Gap)ë¥¼ ì˜ˆë°©í•©ë‹ˆë‹¤." },
            { item: "í˜ˆì••ê³„ì˜ ì¡°ì ˆ ë°¸ë¸Œë¥¼ ì ê·¸ê³  ì••ë ¥ bulbë¥¼ ëˆŒëŸ¬ í˜ˆì••ê³„ì˜ ëˆˆê¸ˆì´ 160~200mmHgê¹Œì§€ ì˜¬ë¼ê°€ê²Œ ê³µê¸°ë¥¼ ë„£ëŠ”ë‹¤.", rationale: "ì¼ë°˜ì ìœ¼ë¡œ 160~200mmHgê¹Œì§€ ì••ë ¥ì„ ê°€í•˜ì—¬ ë™ë§¥ì„ ì™„ì „íˆ íì‡„ì‹œí‚µë‹ˆë‹¤." },
            { item: "ì¡°ì ˆ ë°¸ë¸Œë¥¼ ì²œì²œíˆ ì—´ì–´ 1ì´ˆì— 2mmHgì”© ëˆˆê¸ˆì„ ë‚´ë¦¬ë©´ì„œ ì²˜ìŒ ì†Œë¦¬ê°€ ë“¤ë¦¬ëŠ” ì§€ì ì˜ ëˆˆê¸ˆì„ ì½ì–´ì„œ ê¸°ì–µí•œë‹¤.", rationale: "ìˆ˜ì¶•ê¸° í˜ˆì••(Systolic BP)ì„ ì •í™•íˆ ì¸¡ì •í•˜ê¸° ìœ„í•´ ì••ë ¥ì„ ì²œì²œíˆ ë‚´ë¦½ë‹ˆë‹¤." },
            { item: "ì¡°ì ˆ ë°¸ë¸Œë¥¼ ì²œì²œíˆ ì—´ì–´ ì°¨ì¸° ì»¤í”„ì—ì„œ ê³µê¸°ë¥¼ ë¹¼ë©´ì„œ ì†Œë¦¬ê°€ ì—†ì–´ì§€ëŠ” ì§€ì ì˜ ëˆˆê¸ˆì„ ì½ì–´ì„œ ê¸°ì–µí•œë‹¤.", rationale: "ì´ì™„ê¸° í˜ˆì••(Diastolic BP)ì„ ì •í™•íˆ ì¸¡ì •í•˜ê¸° ìœ„í•´ ì†Œì‹¤ë˜ëŠ” ì§€ì ì„ í™•ì¸í•©ë‹ˆë‹¤." },
            { item: "ì¡°ì ˆ ë°¸ë¸Œë¥¼ ì™„ì „íˆ ì—´ì–´ ì»¤í”„ì—ì„œ ê³µê¸°ë¥¼ ì™„ì „íˆ ëº€ í›„ ì»¤í”„ë¥¼ í’€ì–´, í˜ˆì••ê³„ë¥¼ ì •ë¦¬í•œë‹¤.", rationale: "í˜ˆì•¡ ìˆœí™˜ì„ ë°©í•´í•˜ì§€ ì•Šê³  ì¥ë¹„ë¥¼ ë³´í˜¸í•©ë‹ˆë‹¤." },
            { item: "ëŒ€ìƒìì˜ í™˜ì˜ë¥¼ ì •ë¦¬í•œë‹¤. ì¸¡ì •ëœ í˜ˆì••ì„ ë©”ëª¨í•œë‹¤.", rationale: "í™˜ìì˜ í”„ë¼ì´ë²„ì‹œë¥¼ ì¡´ì¤‘í•˜ê³  ë‹¤ìŒ ê°„í˜¸ ê¸°ë¡ì„ ì¤€ë¹„í•©ë‹ˆë‹¤." },
            { item: "ì²­ì§„ê¸°ì˜ ê·€ê½‚ì´(ear piece)ì™€ íŒë§‰(diaphragm)ì„ ì†Œë…ì†œìœ¼ë¡œ ë‹¦ëŠ”ë‹¤. ë¬¼ê³¼ ë¹„ëˆ„ë¡œ ì†ìœ„ìƒì„ ì‹¤ì‹œí•œë‹¤. ê°„í˜¸ê¸°ë¡ì§€ì— í˜¸í¡, ì²´ì˜¨, ë§¥ë°•, í˜ˆì••ì¸¡ì •ì¹˜ë¥¼ ê¸°ë¡í•œë‹¤.", rationale: "ê°ì—¼ ê´€ë¦¬ë¥¼ ë§ˆë¬´ë¦¬í•˜ê³  ì¸¡ì • ê²°ê³¼ë¥¼ ê³µì‹ì ìœ¼ë¡œ ê¸°ë¡í•˜ì—¬ í›„ì† ê°„í˜¸ì— í™œìš©í•©ë‹ˆë‹¤." }
        ];
        
        // --- END VITAL SIGN DATA ---

        // State Management 
        let currentStep = 1; // For Procedure Learning Tab (1-6 steps)
        let fullChecklistState = {}; // State for the full 25-item checklist
        
        // --- Core View Management ---

        /**
         * Switches the main screen view.
         */
        function showView(viewId, initialSubView = null) {
            console.log(`Switching main view to: ${viewId}`); // Debug log
            const views = document.querySelectorAll('.app-view-main');
            views.forEach(view => view.classList.add('hidden'));

            const activeView = document.getElementById(viewId);
            if (activeView) {
                activeView.classList.remove('hidden');
                
                if (viewId === 'skill-list-view') {
                    renderSkillList();
                } else if (viewId === 'procedure-detail-view') {
                    // Default to the Overview View
                    renderSubView(initialSubView || 'overview-view');
                }
            }
            
            // Hide/Show 'back to list' button
            const backButton = document.getElementById('back-to-list-btn');
            if (viewId === 'skill-list-view' || viewId === 'welcome-view') {
                backButton.classList.add('hidden');
            } else {
                backButton.classList.remove('hidden');
            }
        }
        window.showView = showView;
        
        /**
         * Switches the sub-view (tabs) within the procedure detail screen.
         */
        function renderSubView(viewId) {
            console.log(`Switching sub view to: ${viewId}`); // Debug log
            const views = document.querySelectorAll('.app-view-sub');
            views.forEach(view => {
                view.classList.add('hidden');
                view.classList.remove('flex');
            });

            const activeView = document.getElementById(viewId);
            if (activeView) {
                activeView.classList.remove('hidden');
                activeView.classList.add('flex');
            }

            // Update navigation active state
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('bg-indigo-600', 'text-white', 'shadow-inner');
                link.classList.add('text-indigo-700', 'hover:bg-indigo-100');
            });
            const activeLink = document.querySelector(`.nav-link[data-view="${viewId}"]`);
            if (activeLink) {
                activeLink.classList.add('bg-indigo-600', 'text-white', 'shadow-inner');
                activeLink.classList.remove('text-indigo-700', 'hover:bg-indigo-100');
            }
            
            // Specific rendering for each tab
            if (viewId === 'overview-view') {
                renderOverviewView();
            } else if (viewId === 'procedure-learning-view') {
                renderProcedureLearningView();
            } else if (viewId === 'checklist-view') {
                renderChecklistView();
            } else if (viewId === 'charting-view') {
                renderChartingView();
            } else if (viewId === 'progress-view') {
                 // Data is automatically rendered by onSnapshot listener setup
            }
            // Hide/Show step navigation based on the active tab
            const stepNav = document.getElementById('step-navigation');
            if (viewId === 'procedure-learning-view') {
                 stepNav.classList.remove('hidden');
            } else {
                 stepNav.classList.add('hidden');
            }
        }
        window.renderSubView = renderSubView;


        // --- Skill List View Logic ---

        function getDifficultyClass(difficulty) {
            switch (difficulty) {
                case "í•˜": return "bg-green-100 text-green-700 border-green-300";
                case "ì¤‘": return "bg-yellow-100 text-yellow-700 border-yellow-300";
                case "ìƒ": return "bg-red-100 text-red-700 border-red-300";
                default: return "bg-gray-100 text-gray-700 border-gray-300";
            }
        }

        function renderSkillList() {
            const listContainer = document.getElementById('skill-list-container');
            
            const html = CORE_SKILLS.map(skill => {
                const isDemo = skill.linkId === 'vital-signs';
                const buttonClass = isDemo ? 'bg-indigo-500 hover:bg-indigo-600' : 'bg-gray-400 cursor-not-allowed';
                const buttonText = isDemo ? 'í•™ìŠµ ì‹œì‘' : 'ê°œë°œ ì˜ˆì •';
                const onClick = isDemo ? `showSkillDetail('${skill.name}')` : `showMessageBox('ì¤€ë¹„ ì¤‘', 'ë‹¤ë¥¸ ìˆ ê¸° í•™ìŠµ ëª¨ë“ˆì€ í˜„ì¬ ê°œë°œ ì˜ˆì •ì…ë‹ˆë‹¤.', 'info')`;

                return `
                    <div class="skill-item p-4 bg-white rounded-xl shadow-md flex justify-between items-center border border-gray-200">
                        <div class="flex items-center flex-1 min-w-0">
                            <span class="text-3xl mr-3">${skill.emoji}</span>
                            <div>
                                <h3 class="font-semibold text-lg text-gray-800 truncate">${skill.name}</h3>
                                <span class="inline-block mt-1 px-3 py-1 text-xs font-medium rounded-full border ${getDifficultyClass(skill.difficulty)}">
                                    ë‚œì´ë„: ${skill.difficulty}
                                </span>
                            </div>
                        </div>
                        <button onclick="${onClick}" class="ml-4 px-4 py-2 text-sm font-medium text-white rounded-lg ${buttonClass} transition-colors">
                            ${buttonText}
                        </button>
                    </div>
                `;
            }).join('');
            
            listContainer.innerHTML = html;
        }

        function showSkillDetail(skillName) {
            if (skillName === "í™œë ¥ì§•í›„ ì¸¡ì •") {
                showView('procedure-detail-view', 'overview-view'); // Default to 'ê°œìš”' tab
            } else {
                showMessageBox('ê°œë°œ ì˜ˆì •', `${skillName} í•™ìŠµ ëª¨ë“ˆì€ í˜„ì¬ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.`, 'info');
            }
        }
        window.showSkillDetail = showSkillDetail;

        // --- New Feature: Overview View Logic (User Request 1: Single Marker) ---
        function renderOverviewView() {
            const view = document.getElementById('overview-view');
            
            // 1. ì„±ì·¨ ëª©í‘œ (Learning Objectives) - Requested Content
            const learningObjectives = [
                "ì²´ì˜¨, ë§¥ë°•, í˜¸í¡, í˜ˆì••ì˜ ê¸°ì „ì„ ì„¤ëª…í•  ìˆ˜ ìˆë‹¤.",
                "ì²´ì˜¨, ë§¥ë°•, í˜¸í¡, í˜ˆì••ì„ ì¸¡ì •í•  ìˆ˜ ìˆë‹¤.",
                "ì²´ì˜¨, ë§¥ë°•, í˜¸í¡, í˜ˆì••ì˜ ì¸¡ì • ê²°ê³¼ë¥¼ ê¸°ë¡í•  ìˆ˜ ìˆë‹¤."
            ];

            // 2. ì„ í–‰ ì§€ì‹ (Prerequisite Knowledge)
            const prerequisiteKnowledge = [
                "ì²´ì˜¨, ë§¥ë°•, í˜¸í¡, í˜ˆì••ì˜ ì •ì˜ì™€ ì •ìƒë²”ìœ„",
                "ì²´ì˜¨, ë§¥ë°•, í˜¸í¡, í˜ˆì••ì— ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” ìš”ì¸"
            ];

            // 3. ì¤€ë¹„ ë¬¼í’ˆ (Preparation Items)
            const preparationItems = [
                "ì´ˆì¹¨ì´ ìˆëŠ” ì‹œê³„",
                "ì „ì ì²´ì˜¨ê³„/ê³ ë§‰ ì²´ì˜¨ê³„(1íšŒìš© íƒì¹¨ ë®ê°œ)",
                "ì•„ë„¤ë¡œì´ë“œ í˜ˆì••ê³„",
                "ì²­ì§„ê¸°(êµìœ¡ìš© ì²­ì§„ê¸° ì¤€ë¹„)",
                "ì†ì†Œë…ì œ",
                "ìŸë°˜(Tray), ê³¡ë°˜",
                "ì†Œë…ì†œ",
                "ê°„í˜¸ê¸°ë¡ì§€",
                "ì˜ë£Œíê¸°ë¬¼ ì „ìš©ìš©ê¸°(ì¼ë°˜)"
            ];

            // User Request 1: Modified renderList to use a single custom marker (flex/span)
            const renderList = (items) => items.map(item => `
                <li class="text-gray-700 mb-2 flex items-start">
                    <span class="mr-2 text-indigo-500 font-bold">â€¢</span>
                    <span class="flex-1">${item}</span>
                </li>`).join('');


            view.innerHTML = `
                <div class="flex flex-col flex-1 p-4 overflow-y-auto">
                    <h3 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">ğŸ“‹ í™œë ¥ì§•í›„ ì¸¡ì • (Vital Signs) ê°œìš”</h3>
                    
                    <!-- 1. ì„±ì·¨ ëª©í‘œ -->
                    <div class="bg-indigo-50 p-5 rounded-xl shadow-md mb-6 border border-indigo-200">
                        <p class="font-bold text-indigo-700 mb-3 flex items-center"><i data-lucide="target" class="w-5 h-5 mr-2"></i> ì„±ì·¨ ëª©í‘œ</p>
                        <ul class="space-y-2 text-sm">
                            ${renderList(learningObjectives)}
                        </ul>
                    </div>

                    <!-- 2. ì„ í–‰ ì§€ì‹ -->
                    <div class="bg-white p-5 rounded-xl shadow-md mb-6 border border-gray-200">
                        <p class="font-bold text-gray-700 mb-3 flex items-center"><i data-lucide="book-open" class="w-5 h-5 mr-2 text-green-600"></i> ì„ í–‰ ì§€ì‹</p>
                        <ul class="space-y-2 text-sm">
                            ${renderList(prerequisiteKnowledge)}
                        </ul>
                    </div>

                    <!-- 3. ì¤€ë¹„ ë¬¼í’ˆ -->
                    <div class="bg-white p-5 rounded-xl shadow-md mb-6 border border-gray-200">
                        <p class="font-bold text-gray-700 mb-3 flex items-center"><i data-lucide="shopping-bag" class="w-5 h-5 mr-2 text-red-600"></i> ì¤€ë¹„ ë¬¼í’ˆ</p>
                        <ul class="space-y-2 text-sm">
                            ${renderList(preparationItems)}
                        </ul>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }
        window.renderOverviewView = renderOverviewView;

        // --- Feature 1: Clinical Tip Generation (in Procedure Learning View) ---
        async function getClinicalTip() {
            const stepData = VITAL_SIGN_STEPS[currentStep - 1];
            const tipBox = document.getElementById('clinical-tip-box');
            const button = document.getElementById('get-tip-btn');
            
            if (!stepData) return;

            button.disabled = true;
            button.innerHTML = '<i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i> íŒ ìƒì„± ì¤‘...';
            lucide.createIcons();
            tipBox.innerHTML = '<p class="text-gray-500 italic">Geminiê°€ ì„ìƒ íŒì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>';

            const systemPrompt = "You are a senior clinical nurse with over 10 years of experience. Your task is to provide a concise, real-world clinical tip or warning about a common pitfall for the specific nursing procedure step provided. Keep the tone professional but practical. Respond in Korean. Use Markdown formatting (bold, lists) for clarity, but only use Korean text.";
            const userQuery = `í•µì‹¬ ê°„í˜¸ ìˆ ê¸° ë‹¨ê³„: ${stepData.title}\nì ˆì°¨: ${stepData.procedure}\n\nì´ ë‹¨ê³„ì—ì„œ ì´ˆë³´ ê°„í˜¸ì‚¬ê°€ í”íˆ ì €ì§€ë¥´ëŠ” ì‹¤ìˆ˜ë‚˜, ë°˜ë“œì‹œ ì§€ì¼œì•¼ í•  ì„ìƒì  íŒì„ 2~3ë¬¸ì¥ ì´ë‚´ë¡œ ì œê³µí•´ ì£¼ì„¸ìš”.`;

            try {
                const tip = await fetchGeminiContent(userQuery, systemPrompt);
                tipBox.innerHTML = `
                    <div class="bg-yellow-50 p-4 rounded-lg border-l-4 border-yellow-500 shadow-sm">
                        <p class="font-bold text-yellow-800 mb-2 flex items-center">
                            <i data-lucide="sparkles" class="w-5 h-5 mr-1 fill-yellow-500 text-yellow-500"></i> ì„ìƒ í˜„ì¥ íŒ
                        </p>
                        <div class="text-sm text-gray-700 prose">${tip}</div>
                    </div>
                `;
            } catch (error) {
                tipBox.innerHTML = '<p class="text-red-500">íŒ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</p>';
            } finally {
                button.disabled = false;
                button.innerHTML = '<i data-lucide="sparkles" class="w-5 h-5 mr-2 fill-white text-white"></i> ì„ìƒ íŒ ë°›ê¸°';
                lucide.createIcons();
            }
        }
        window.getClinicalTip = getClinicalTip;

        // --- Procedure Learning View Logic (Main procedure content) ---

        function renderProcedureLearningView() {
            const view = document.getElementById('procedure-learning-view');
            const stepData = VITAL_SIGN_STEPS[currentStep - 1];
            
            if (!stepData) return;

            // Update procedure title (Shared title, only update here)
            document.getElementById('procedure-title-step-count').textContent = `| ë‹¨ê³„ ${currentStep} / ${VITAL_SIGN_STEPS.length}`;

            let html = `
                <!-- Procedure Content Area -->
                <div id="procedure-content" class="p-4 bg-gray-50 rounded-lg shadow-inner mb-6 flex-1">
                    <h4 class="text-lg font-bold text-indigo-700 mb-3">${stepData.title}</h4>
                    
                    <!-- YouTube Video Link (User Request 2) -->
                    <div class="aspect-video bg-gray-100 rounded-lg mb-6 flex flex-col items-center justify-center text-gray-600 p-4 border border-indigo-200">
                        <p class="text-sm mb-3">í™œë ¥ì§•í›„ ì¸¡ì • ì‹¤ìŠµ ì˜ìƒ (QR_11)</p>
                        <a href="${VIDEO_URL}" target="_blank" class="flex items-center justify-center px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition-colors shadow-md text-sm">
                            <i data-lucide="monitor-play" class="w-5 h-5 mr-2"></i> ì˜ìƒ ë³´ê¸° (ìƒˆ ì°½ ì—´ë¦¼)
                        </a>
                    </div>

                    <!-- Procedure Step Details -->
                    <div class="bg-indigo-50 p-4 rounded-lg mb-6 border-l-4 border-indigo-500">
                        <p class="font-semibold text-indigo-700 mb-2">í•µì‹¬ ìˆ ê¸° ì ˆì°¨</p>
                        <p class="text-gray-700">${stepData.procedure}</p>
                    </div>
                    
                    <!-- Gemini Clinical Tip Button and Output -->
                    <div id="clinical-tip-container" class="mb-6">
                        <button id="get-tip-btn" onclick="getClinicalTip()" class="flex items-center px-4 py-2 text-sm font-medium rounded-lg text-white bg-pink-500 hover:bg-pink-600 transition-colors shadow-md">
                            <i data-lucide="sparkles" class="w-5 h-5 mr-2 fill-white text-white"></i> ì„ìƒ íŒ ë°›ê¸°
                        </button>
                        <div id="clinical-tip-box" class="mt-3">
                            <!-- Gemini Output Here -->
                        </div>
                    </div>

                    <!-- Medical Terms -->
                    <div class="mb-6">
                        <p class="font-semibold text-gray-700 mb-2">í•µì‹¬ ì˜í•™ ìš©ì–´</p>
                        <div class="flex flex-wrap gap-2">
                            ${stepData.terms.map(term => `<span class="px-3 py-1 bg-gray-200 text-gray-700 text-sm rounded-full">${term}</span>`).join('')}
                        </div>
                    </div>

                </div>
            `;
            view.innerHTML = html;
            lucide.createIcons();
        }
        window.renderProcedureLearningView = renderProcedureLearningView;

        function changeStep(delta) {
            currentStep = Math.max(1, Math.min(VITAL_SIGN_STEPS.length, currentStep + delta));
            
            // Reset tip box and re-render the learning view
            const tipBox = document.getElementById('clinical-tip-box');
            if (tipBox) tipBox.innerHTML = '';
            
            // Rerender procedure learning view
            renderProcedureLearningView();
        }
        window.changeStep = changeStep;
        
        // --- Checklist View Logic (Self-Assessment & Rationale Toggle - User Request 3) ---
        
        /**
         * ì²´í¬ë°•ìŠ¤ ìƒíƒœë¥¼ í† ê¸€í•˜ê³  ì´ë¡ ì  ê·¼ê±°ì˜ ê°€ì‹œì„±ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤. (ìŠ¤í¬ë¡¤ íŠ•ê¹€ í˜„ìƒ í•´ê²°ì„ ìœ„í•´ DOM ì§ì ‘ ì¡°ì‘ìœ¼ë¡œ ë³€ê²½ë¨)
         * @param {HTMLInputElement} checkboxEl - ì²´í¬ë°•ìŠ¤ ìš”ì†Œ
         * @param {string} index - ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª©ì˜ ì¸ë±ìŠ¤ (ë¬¸ìì—´)
         */
        function handleChecklistToggle(checkboxEl, index) {
            // 1. ìƒíƒœ ì—…ë°ì´íŠ¸
            const isChecked = checkboxEl.checked;
            fullChecklistState[index] = isChecked;

            // 2. í•­ëª© ì»¨í…Œì´ë„ˆì˜ í´ë˜ìŠ¤ ì—…ë°ì´íŠ¸ (ìŠ¤í¬ë¡¤ íŠ•ê¹€ ë¬¸ì œ í•´ê²° í•µì‹¬)
            const parentDiv = checkboxEl.closest('.checklist-item-container');
            if (parentDiv) {
                // ê¸°ì¡´ ë°°ê²½/ê²½ê³„ ìŠ¤íƒ€ì¼ í´ë˜ìŠ¤ ì œê±°
                parentDiv.classList.remove('bg-green-50', 'border-green-300', 'shadow-sm', 'bg-gray-50', 'hover:bg-gray-100', 'border-gray-200');

                // ìƒíƒœì— ë”°ë¥¸ ìƒˆ í´ë˜ìŠ¤ ì¶”ê°€
                if (isChecked) {
                    parentDiv.classList.add('bg-green-50', 'border', 'border-green-300', 'shadow-sm');
                } else {
                    parentDiv.classList.add('bg-gray-50', 'hover:bg-gray-100', 'border', 'border-gray-200');
                }
            }


            // 3. ì´ë¡ ì  ê·¼ê±° DOM ì—…ë°ì´íŠ¸ (visible í´ë˜ìŠ¤ í† ê¸€)
            const rationaleEl = document.getElementById(`rationale-${index}`);
            if (rationaleEl) {
                if (isChecked) {
                    rationaleEl.classList.add('visible');
                    rationaleEl.classList.remove('hidden'); // Ensure it starts the transition from not hidden
                } else {
                    rationaleEl.classList.remove('visible');
                    // 'hidden'ì€ max-height:0 íŠ¸ëœì§€ì…˜ í›„ì— ìì—°ìŠ¤ëŸ½ê²Œ ë°œìƒ
                }
            }
            
            // NOTE: ìŠ¤í¬ë¡¤ íŠ•ê¹€ í˜„ìƒ í•´ê²°ì„ ìœ„í•´ renderChecklistView() í˜¸ì¶œì„ ì œê±°í•¨
            console.log(`Checklist item ${index} toggled. Scroll position preserved.`);
        }
        window.handleChecklistToggle = handleChecklistToggle;
        

        function renderChecklistView() {
            const view = document.getElementById('checklist-view');
            const totalItems = VITAL_SIGN_CHECKLIST_DATA.length;
            
            let checklistHtml = `
                <div class="flex flex-col flex-1">
                    <h3 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">âœ… í™œë ¥ì§•í›„ ì¸¡ì • ì „ì²´ ìˆ ê¸° ì²´í¬ë¦¬ìŠ¤íŠ¸ (ì´ ${totalItems} í•­ëª©)</h3>
                    
                    <!-- Assessment Content -->
                    <div class="p-6 bg-white rounded-xl shadow-lg mt-2 border-2 border-indigo-200 flex-1 overflow-y-auto">
                        <p class="text-gray-600 mb-4 font-semibold text-lg">ì „ì²´ ìˆ ê¸° ìˆ˜í–‰ ì ê²€</p>
                        <p class="text-sm text-gray-500 mb-4">ì „ì²´ ìˆ ê¸° ê³¼ì •(${totalItems}ê°œ í•­ëª©)ì„ ìŠ¤ìŠ¤ë¡œ í‰ê°€í•˜ê³  ì²´í¬í•˜ì„¸ìš”. í•­ëª© ì²´í¬ ì‹œ ì´ë¡ ì  ê·¼ê±°ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                        <div id="checklist-items" class="space-y-3 max-h-[450px] overflow-y-auto pr-2">
                `;
                
                VITAL_SIGN_CHECKLIST_DATA.forEach((data, index) => {
                    const itemId = `check-${index}`;
                    const isChecked = fullChecklistState[index] || false;
                    const isRationaleVisible = isChecked ? 'visible' : '';
                    const hiddenClass = isChecked ? '' : 'hidden'; // Initial visibility based on state

                    checklistHtml += `
                        <!-- checklist-item-container í´ë˜ìŠ¤ ì¶”ê°€ -->
                        <div class="rounded-xl overflow-hidden transition duration-150 ease-in-out checklist-item-container ${isChecked ? 'bg-green-50 border border-green-300 shadow-sm' : 'bg-gray-50 hover:bg-gray-100 border border-gray-200'}">
                            <label for="${itemId}" class="flex items-start p-3 cursor-pointer select-none">
                                <input type="checkbox" id="${itemId}" class="form-checkbox h-5 w-5 text-indigo-600 rounded mt-1 mr-3 focus:ring-indigo-500" 
                                       onchange="handleChecklistToggle(this, '${index}')" ${isChecked ? 'checked' : ''}>
                                <span class="text-base text-gray-800 flex-1">(${index + 1}) ${data.item}</span>
                            </label>
                            
                            <!-- Rationale Container (User Request 3) -->
                            <div id="rationale-${index}" class="rationale-container px-3 ${isRationaleVisible} ${hiddenClass}">
                                <div class="border-t border-green-200 mt-0 pt-2">
                                    <p class="font-semibold text-sm text-green-800 mb-1">ğŸ’¡ ì´ë¡ ì  ê·¼ê±°:</p>
                                    <p class="text-sm text-green-700">${data.rationale}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                checklistHtml += `
                        </div>
                        <button onclick="saveAssessment()" class="w-full mt-6 flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-xl shadow-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <i data-lucide="save" class="w-5 h-5 mr-2"></i> í‰ê°€ ê²°ê³¼ ì €ì¥ ë° ì§„ë„ ê¸°ë¡
                        </button>
                    </div>
                </div>
            `;
            view.innerHTML = checklistHtml;
            lucide.createIcons();
        }
        window.renderChecklistView = renderChecklistView;
        

        async function saveAssessment() {
            if (!window.currentUserId) {
                showMessageBox('ì¸ì¦ ì˜¤ë¥˜', 'ì‚¬ìš©ì ì¸ì¦ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const totalItems = VITAL_SIGN_CHECKLIST_DATA.length;
            
            // Calculate score based on the full checklist
            const completedItems = Object.keys(fullChecklistState).filter(key => fullChecklistState[key]).length;
            
            const score = (completedItems / totalItems) * 100;

            const assessmentData = {
                userId: window.currentUserId,
                skillId: 'vital-signs', // Fixed ID for the entire procedure
                skillTitle: 'í™œë ¥ì§•í›„ ì¸¡ì • ì „ì²´ ìˆ ê¸°',
                score: Math.round(score),
                totalItems: totalItems,
                completedItems: completedItems,
                checklistDetails: JSON.stringify(fullChecklistState), // Save entire state
                timestamp: serverTimestamp(),
                isCompleted: score === 100
            };

            const saveBtn = document.querySelector('#checklist-view button[onclick="saveAssessment()"]');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i> ì €ì¥ ì¤‘...';

            try {
                const db = getFirestore();
                const progressRef = getSkillCollectionRef(db, window.appId, window.currentUserId);
                
                await addDoc(progressRef, assessmentData);
                
                showMessageBox(`'í™œë ¥ì§•í›„ ì¸¡ì •' í‰ê°€ ê¸°ë¡ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`, `ì ìˆ˜: ${Math.round(score)}% (${completedItems}/${totalItems})`, 'success');

                // Move to progress view after saving
                renderSubView('progress-view');
            } catch (error) {
                console.error("Error saving assessment:", error);
                showMessageBox('í‰ê°€ ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨', 'ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i data-lucide="save" class="w-5 h-5 mr-2"></i> í‰ê°€ ê²°ê³¼ ì €ì¥ ë° ì§„ë„ ê¸°ë¡';
                lucide.createIcons();
            }
        }
        window.saveAssessment = saveAssessment;

        // --- Feature 2: Charting Assistant (in Charting View) ---

        function renderChartingView() {
            const view = document.getElementById('charting-view');
            view.innerHTML = `
                <div class="flex flex-col flex-1 p-4 overflow-y-auto">
                    <h3 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">âœ¨ ê°„í˜¸ ê¸°ë¡ ì´ˆì•ˆ ìƒì„±ê¸°</h3>
                    <p class="text-gray-600 mb-6">í™œë ¥ì§•í›„ì™€ í™˜ìì˜ ìƒíƒœë¥¼ ì…ë ¥í•˜ë©´, ì„ìƒì  íŒë‹¨ì— ê¸°ë°˜í•œ **ê°„í˜¸ ê¸°ë¡(Charting Note)** ì´ˆì•ˆì„ ìƒì„±í•´ ë“œë¦½ë‹ˆë‹¤.</p>

                    <div class="space-y-4 mb-8 p-6 bg-white rounded-xl shadow-lg border border-gray-100">
                        <div class="grid grid-cols-2 gap-4">
                            <label class="block">
                                <span class="text-gray-700 font-medium">ì²´ì˜¨ (T, Â°C)</span>
                                <input id="chart-t" type="number" step="0.1" placeholder="36.5" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                            </label>
                            <label class="block">
                                <span class="text-gray-700 font-medium">ë§¥ë°• (P, íšŒ/ë¶„)</span>
                                <input id="chart-p" type="number" placeholder="72" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                            </label>
                            <label class="block">
                                <span class="text-gray-700 font-medium">í˜¸í¡ (R, íšŒ/ë¶„)</span>
                                <input id="chart-r" type="number" placeholder="18" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                            </label>
                            <label class="block">
                                <span class="text-gray-700 font-medium">í˜ˆì•• (BP, mmHg)</span>
                                <input id="chart-bp" type="text" placeholder="120/80" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                            </label>
                        </div>
                        
                        <label class="block pt-2">
                            <span class="text-gray-700 font-medium">í™˜ì ì£¼ìš” ì¦ìƒ ë° ê°ê´€ì /ì£¼ê´€ì  ìƒíƒœ (í•„ìˆ˜)</span>
                            <textarea id="chart-symptoms" rows="3" placeholder="ì˜ˆ: 'ë‘í†µ í˜¸ì†Œ', 'ì‹ì€ë•€ í˜ë¦¼', 'ì˜ì‹ ëª…ë£Œí•¨' ë“±" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
                        </label>

                        <button onclick="generateChartingNote()" id="charting-btn" class="w-full flex items-center justify-center px-4 py-3 text-base font-bold rounded-xl text-white bg-indigo-600 hover:bg-indigo-700 transition-colors shadow-md mt-4">
                            <i data-lucide="bot" class="w-5 h-5 mr-2"></i> ê¸°ë¡ ì´ˆì•ˆ ìƒì„±
                        </button>
                    </div>

                    <h3 class="text-lg font-bold text-gray-700 mb-3">ìƒì„±ëœ ê°„í˜¸ ê¸°ë¡ ì´ˆì•ˆ</h3>
                    <div id="charting-output" class="p-4 bg-gray-100 rounded-lg min-h-[150px] shadow-inner text-gray-700">
                        <p class="text-gray-500 italic text-sm">ê¸°ë¡ ì´ˆì•ˆì„ ìƒì„±í•˜ë ¤ë©´ ìœ„ì˜ ì–‘ì‹ì„ ì‘ì„±í•˜ê³  ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }
        window.renderChartingView = renderChartingView;

        async function generateChartingNote() {
            const t = document.getElementById('chart-t').value;
            const p = document.getElementById('chart-p').value;
            const r = document.getElementById('chart-r').value;
            const bp = document.getElementById('chart-bp').value;
            const symptoms = document.getElementById('chart-symptoms').value;
            const output = document.getElementById('charting-output');
            const button = document.getElementById('charting-btn');

            if (!symptoms) {
                showMessageBox('ì…ë ¥ ë¶€ì¡±', 'í™˜ìì˜ ì£¼ìš” ì¦ìƒ ë° ìƒíƒœë¥¼ ë°˜ë“œì‹œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.', 'warning');
                return;
            }

            button.disabled = true;
            button.innerHTML = '<i data-lucide="loader" class="w-5 h-5 mr-2 animate-spin"></i> ì´ˆì•ˆ ìƒì„± ì¤‘...';
            output.innerHTML = '<p class="text-gray-500 italic text-sm">Geminiê°€ ì „ë¬¸ì ì¸ ê°„í˜¸ ê¸°ë¡ ì´ˆì•ˆì„ ì‘ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>';
            lucide.createIcons();

            const vts = `ì²´ì˜¨(T): ${t || 'ê¸°ë¡ ì—†ìŒ'}Â°C, ë§¥ë°•(P): ${p || 'ê¸°ë¡ ì—†ìŒ'}íšŒ/ë¶„, í˜¸í¡(R): ${r || 'ê¸°ë¡ ì—†ìŒ'}íšŒ/ë¶„, í˜ˆì••(BP): ${bp || 'ê¸°ë¡ ì—†ìŒ'} mmHg`;

            const systemPrompt = "You are a professional registered nurse. Your task is to generate a concise, objective, and well-structured nursing note (Charting Note) based on the provided vital signs and patient symptoms. Use the SOAP (Subjective, Objective, Assessment, Plan) or DAR (Data, Action, Response) format, making it clear and clinically relevant. Use Korean for the final output. Do not include a time or date placeholder or your signature. Just provide the note content.";
            const userQuery = `ë‹¤ìŒ í™˜ì ë°ì´í„°ì— ëŒ€í•´ ê°„í˜¸ ê¸°ë¡ ì´ˆì•ˆì„ ì‘ì„±í•´ ì£¼ì„¸ìš”. ì „ë¬¸ ê°„í˜¸ì‚¬ì²˜ëŸ¼ ì‘ì„±í•˜ê³ , í•„ìš”í•œ ê²½ìš° í›„ì† ì¡°ì¹˜(Plan/Action)ë¥¼ ì œì‹œí•´ì£¼ì„¸ìš”.\n\ní™œë ¥ì§•í›„: ${vts}\nì£¼ìš” ì¦ìƒ ë° ìƒíƒœ: ${symptoms}`;

            try {
                const note = await fetchGeminiContent(userQuery, systemPrompt);
                output.innerHTML = `
                    <div class="text-sm bg-white p-4 rounded-lg border border-indigo-200 whitespace-pre-wrap font-mono">
                        ${note}
                    </div>
                `;
            } catch (error) {
                output.innerHTML = '<p class="text-red-500">ê¸°ë¡ ì´ˆì•ˆ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</p>';
            } finally {
                button.disabled = false;
                button.innerHTML = '<i data-lucide="bot" class="w-5 h-5 mr-2"></i> ê¸°ë¡ ì´ˆì•ˆ ìƒì„±';
                lucide.createIcons();
            }
        }
        window.generateChartingNote = generateChartingNote;


        // --- Utility & Progress View Logic (Firestore) ---

        function getSkillCollectionRef(db, appId, userId) {
            const collectionPath = `artifacts/${appId}/users/${userId}/nursing_progress`;
            return collection(db, collectionPath);
        }

        function showMessageBox(title, message, type) {
            const box = document.getElementById('message-box');
            const icon = document.getElementById('message-icon');
            const titleEl = document.getElementById('message-title');
            const messageEl = document.getElementById('message-message');
            const closeBtn = document.getElementById('message-close-btn');

            let bgColor, iconSvg;
            if (type === 'success') { bgColor = 'bg-green-500'; iconSvg = `<i data-lucide="check-circle" class="w-6 h-6"></i>`; } 
            else if (type === 'error') { bgColor = 'bg-red-500'; iconSvg = `<i data-lucide="alert-triangle" class="w-6 h-6"></i>`; } 
            else { bgColor = 'bg-blue-500'; iconSvg = `<i data-lucide="info" class="w-6 h-6"></i>`; }

            box.classList.remove('hidden', 'bg-green-500', 'bg-red-500', 'bg-blue-500');
            box.classList.add('flex', 'p-4', bgColor);
            icon.innerHTML = iconSvg;
            titleEl.textContent = title;
            messageEl.textContent = message;

            closeBtn.onclick = () => box.classList.add('hidden');
            lucide.createIcons();
        }
        window.showMessageBox = showMessageBox;

        let progressRecords = [];

        function setupDataListeners() {
            if (!window.currentUserId || !window.db) return;

            const db = getFirestore();
            const progressRef = getSkillCollectionRef(db, window.appId, window.currentUserId);
            
            // NOTE: orderBy is removed to prevent index errors. Data is sorted in memory.
            const q = query(progressRef);
            
            onSnapshot(q, (snapshot) => {
                progressRecords = [];
                snapshot.forEach((doc) => {
                    progressRecords.push({ id: doc.id, ...doc.data() });
                });
                // Sort data by timestamp in memory (descending)
                progressRecords.sort((a, b) => {
                    const timeA = a.timestamp ? a.timestamp.toDate().getTime() : 0;
                    const timeB = b.timestamp ? b.timestamp.toDate().getTime() : 0;
                    return timeB - timeA;
                });

                renderProgressView();
            }, (error) => {
                console.error("Error listening to progress data:", error);
                document.getElementById('progress-list').innerHTML = '<p class="text-red-500">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
            });
        }
        window.setupDataListeners = setupDataListeners;

        function renderProgressView() {
            const listEl = document.getElementById('progress-list');
            const totalScoreEl = document.getElementById('average-score');
            const progressChartEl = document.getElementById('overall-progress-chart');

            if (progressRecords.length === 0) {
                listEl.innerHTML = '<div class="p-6 text-center text-gray-500 bg-white rounded-xl shadow-sm">ì•„ì§ ì €ì¥ëœ í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. í•™ìŠµí•˜ê³  ìê¸° í‰ê°€ë¥¼ ì €ì¥í•´ ë³´ì„¸ìš”!</div>';
                totalScoreEl.textContent = '0%';
                progressChartEl.style.width = '0%';
                return;
            }

            // Filter records for the specific skill 'í™œë ¥ì§•í›„ ì¸¡ì • ì „ì²´ ìˆ ê¸°'
            const vitalSignRecords = progressRecords.filter(r => r.skillId === 'vital-signs');
            
            if (vitalSignRecords.length === 0) {
                 listEl.innerHTML = '<div class="p-6 text-center text-gray-500 bg-white rounded-xl shadow-sm">ì•„ì§ \'í™œë ¥ì§•í›„ ì¸¡ì •\'ì— ëŒ€í•œ ì €ì¥ëœ í‰ê°€ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                 totalScoreEl.textContent = '0%';
                 progressChartEl.style.width = '0%';
                 return;
            }

            const totalScoreSum = vitalSignRecords.reduce((sum, record) => sum + (record.score || 0), 0);
            const averageScore = totalScoreSum / vitalSignRecords.length;
            
            // Calculate overall progress based on the last recorded score (as a proxy for completion)
            const latestScore = vitalSignRecords[0].score || 0; // Highest score or latest score could be used
            const skillProgress = latestScore; // Use latest score for progress bar

            totalScoreEl.textContent = `${Math.round(averageScore)}%`;
            progressChartEl.style.width = `${Math.min(100, skillProgress)}%`;
            
            listEl.innerHTML = vitalSignRecords.map(record => {
                const date = record.timestamp ? new Date(record.timestamp.toDate()).toLocaleString('ko-KR') : 'ë‚ ì§œ ë¯¸ìƒ';
                const scoreColor = record.score >= 90 ? 'text-green-600' : record.score >= 70 ? 'text-yellow-600' : 'text-red-600';
                
                return `
                    <div class="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center border-l-4 ${record.score === 100 ? 'border-green-500' : 'border-indigo-400'}">
                        <div class="flex-1">
                            <p class="font-bold text-gray-800">${record.skillTitle || 'ìˆ ê¸° í•­ëª©'}</p>
                            <p class="text-sm text-gray-500 mt-1">í‰ê°€ì¼: ${date}</p>
                            <p class="text-xs text-indigo-500 mt-1">${record.completedItems}/${record.totalItems} í•­ëª© ì™„ë£Œ</p>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-extrabold ${scoreColor}">${record.score || 0}%</p>
                            <span class="text-xs text-gray-500">${record.isCompleted ? 'ìˆ™ë ¨ ì™„ë£Œ' : 'ë°˜ë³µ í•™ìŠµ í•„ìš”'}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // **ìˆ˜ì •ëœ ë¶€ë¶„: window.onload ëŒ€ì‹  DOMContentLoaded ì‚¬ìš©**
        // Initialize App: Show the welcome screen immediately when the HTML structure is loaded.
        document.addEventListener('DOMContentLoaded', () => {
            showView('welcome-view'); 
        });
    </script>
</head>
<body class="min-h-screen p-4 sm:p-6 pb-20">

    <!-- Message Box (Replacing alert()) -->
    <div id="message-box" class="fixed top-4 right-4 z-50 hidden items-center justify-between text-white p-4 rounded-lg shadow-xl" role="alert">
        <div class="flex items-center">
            <span id="message-icon" class="mr-3"></span>
            <div>
                <p id="message-title" class="font-bold"></p>
                <p id="message-message" class="text-sm"></p>
            </div>
        </div>
        <button id="message-close-btn" class="ml-4 opacity-90 hover:opacity-100">
            <i data-lucide="x" class="w-5 h-5"></i>
        </button>
    </div>

    <div class="container bg-white rounded-2xl shadow-2xl p-4 sm:p-8">
        <!-- Header (Updated to LAMP) -->
        <header class="mb-6 border-b pb-4 flex justify-between items-center">
            <h1 class="text-3xl font-extrabold text-indigo-800 flex items-center">
                <i data-lucide="lamp-ceiling" class="w-8 h-8 mr-2 text-indigo-500 fill-indigo-500"></i>
                LAMP
            </h1>
            <button id="back-to-list-btn" onclick="showView('skill-list-view')" class="hidden px-3 py-1 text-sm font-medium rounded-lg text-indigo-600 bg-indigo-100 hover:bg-indigo-200 transition-colors">
                <i data-lucide="arrow-left" class="w-4 h-4 inline mr-1"></i> ëª©ë¡ìœ¼ë¡œ
            </button>
        </header>
        
        <div id="user-id-display" class="text-xs mb-4 p-1 bg-gray-100 rounded text-gray-600 break-words">ì‚¬ìš©ì ID: ì¸ì¦ ì¤‘...</div>

        <!-- Main Content Area -->
        <div id="app-container" class="min-h-[500px]">

<!-- 1. í™˜ì˜ í™”ë©´ (Welcome View) -->
<div id="welcome-view"
     class="app-view-main flex flex-col hidden items-center justify-center text-center min-h-screen p-4">
  <div class="p-8 bg-indigo-50 rounded-2xl shadow-xl max-w-sm w-full">
    <!-- ì•„ì´ì½˜ -->
    <i data-lucide="graduation-cap" class="w-16 h-16 text-indigo-600 mx-auto mb-4"></i>
    
    <!-- ì œëª© -->
    <h2 class="text-4xl font-extrabold text-indigo-800 mb-2">LAMP</h2>
    
    <!-- ì„¤ëª… -->
    <p class="text-xl font-medium text-gray-700 mb-6">
      <span class="font-mono text-indigo-600">(L)</span>earning 
      <span class="font-mono text-indigo-600">(A)</span>ssistant for 
      <span class="font-mono text-indigo-600">(M)</span>edical 
      <span class="font-mono text-indigo-600">(P)</span>ractice
    </p>

    <p class="text-gray-600 italic mb-8">
      "ê°„í˜¸ ì§€ì‹ì˜ ë¹›ì„ ë°íˆëŠ” í•™ìŠµ ë„ìš°ë¯¸"
    </p>

    <!-- í•™ìŠµ ì‹œì‘í•˜ê¸° ë²„íŠ¼ -->
    <button onclick="showView('skill-list-view')" 
            class="start-button flex items-center justify-center mx-auto px-8 py-4 text-lg font-bold rounded-full text-white bg-indigo-600 hover:bg-indigo-700 transition-colors shadow-lg">
      <i data-lucide="play" class="w-6 h-6 mr-2 fill-white"></i> í•™ìŠµ ì‹œì‘í•˜ê¸°
    </button>

    <!-- ğŸ”½ ë¡œê·¸ì¸ í¼ ì¶”ê°€ -->
    <div class="mt-8 text-left">
      <h3 class="text-indigo-700 font-semibold text-lg mb-3">ë¡œê·¸ì¸</h3>
      <form onsubmit="handleLogin(event)" class="space-y-4">
        <input type="email" id="email" placeholder="ì´ë©”ì¼" required
               class="w-full p-3 border border-indigo-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-400" />
        <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required
               class="w-full p-3 border border-indigo-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-400" />
        <button type="submit"
                class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-xl hover:bg-indigo-700 transition-colors shadow-md">
          ë¡œê·¸ì¸
        </button>
      </form>
    </div>
  </div>
</div>

<script>
  // Lucide ì•„ì´ì½˜ í™œì„±í™”
  lucide.createIcons();

  // ë¡œê·¸ì¸ ì˜ˆì‹œ í•¨ìˆ˜
  function handleLogin(event) {
    event.preventDefault();
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    alert(`ë¡œê·¸ì¸ ì‹œë„: ${email}`);
    // ì‹¤ì œ ë¡œê·¸ì¸ ë¡œì§ (API ìš”ì²­ ë“±) ì¶”ê°€ ê°€ëŠ¥
  }

  // í™”ë©´ ì „í™˜ í•¨ìˆ˜
  function showView(viewId) {
    document.querySelectorAll('.app-view-main').forEach(v => v.classList.add('hidden'));
    document.getElementById(viewId).classList.remove('hidden');
  }
</script>


            <!-- 2. ìˆ ê¸° ëª©ë¡ ë·° (Skill List View) -->
            <div id="skill-list-view" class="app-view-main flex-col hidden">
                <h2 class="text-2xl font-bold text-gray-700 mb-6 border-b pb-2">í•µì‹¬ ê¸°ë³¸ê°„í˜¸ìˆ ê¸° 18ê°€ì§€ ëª©ë¡</h2>
                <div id="skill-list-container" class="space-y-3">
                    <!-- Skill list rendered by JS -->
                </div>
            </div>

            <!-- 3. ìˆ ê¸° ìƒì„¸/í•™ìŠµ ë·° (Procedure Detail View) -->
            <div id="procedure-detail-view" class="app-view-main flex-col hidden">
                
                <!-- Shared Title -->
                <h2 class="text-2xl font-bold text-gray-700 mb-4 border-b pb-2 flex items-center">
                    <span id="procedure-title">í™œë ¥ì§•í›„ ì¸¡ì •</span> 
                    <span id="procedure-title-step-count" class="text-sm font-medium text-gray-500 ml-3"></span>
                </h2>

                <!-- Sub Navigation Tabs (New structure) -->
                <nav class="fixed bottom-0 left-0 right-0 bg-white border-t sm:relative sm:border-t-0 sm:flex sm:justify-center sm:mb-8 z-10">
                    <div class="flex justify-around w-full sm:w-auto sm:space-x-2 p-2 sm:p-0 text-sm font-medium">
                        <!-- New 1. ê°œìš” -->
                        <button class="nav-link flex-1 sm:flex-initial flex flex-col items-center p-2 rounded-xl text-indigo-700 hover:bg-indigo-100 transition-colors" data-view="overview-view" onclick="renderSubView('overview-view')">
                            <i data-lucide="layout-grid" class="w-6 h-6"></i>
                            <span class="text-xs mt-1">ê°œìš”</span>
                        </button>
                        <!-- 2. ìˆ ê¸° ì˜ìƒ -->
                        <button class="nav-link flex-1 sm:flex-initial flex flex-col items-center p-2 rounded-xl text-indigo-700 hover:bg-indigo-100 transition-colors" data-view="procedure-learning-view" onclick="renderSubView('procedure-learning-view')">
                            <i data-lucide="book-open-text" class="w-6 h-6"></i>
                            <span class="text-xs mt-1">ìˆ ê¸° ì˜ìƒ</span>
                        </button>
                        <!-- 3. ì²´í¬ë¦¬ìŠ¤íŠ¸ -->
                        <button class="nav-link flex-1 sm:flex-initial flex flex-col items-center p-2 rounded-xl text-indigo-700 hover:bg-indigo-100 transition-colors" data-view="checklist-view" onclick="renderSubView('checklist-view')">
                            <i data-lucide="clipboard-check" class="w-6 h-6"></i>
                            <span class="text-xs mt-1">ì²´í¬ë¦¬ìŠ¤íŠ¸</span>
                        </button>
                        <!-- 4. ê¸°ë¡ ì´ˆì•ˆ (Gemini) -->
                        <button class="nav-link flex-1 sm:flex-initial flex flex-col items-center p-2 rounded-xl text-indigo-700 hover:bg-indigo-100 transition-colors" data-view="charting-view" onclick="renderSubView('charting-view')">
                            <i data-lucide="file-text" class="w-6 h-6"></i>
                            <span class="text-xs mt-1">ê¸°ë¡ ì´ˆì•ˆ âœ¨</span>
                        </button>
                        <!-- 5. í•™ìŠµ ì§„ë„ -->
                        <button class="nav-link flex-1 sm:flex-initial flex flex-col items-center p-2 rounded-xl text-indigo-700 hover:bg-indigo-100 transition-colors" data-view="progress-view" onclick="renderSubView('progress-view')">
                            <i data-lucide="bar-chart-3" class="w-6 h-6"></i>
                            <span class="text-xs mt-1">í•™ìŠµ ì§„ë„</span>
                        </button>
                        <!-- 6. ì»¤ë®¤ë‹ˆí‹° -->
                        <button class="nav-link flex-1 sm:flex-initial flex flex-col items-center p-2 rounded-xl text-indigo-700 hover:bg-indigo-100 transition-colors" data-view="community-view" onclick="renderSubView('community-view')">
                            <i data-lucide="users" class="w-6 h-6"></i>
                            <span class="text-xs mt-1">ì»¤ë®¤ë‹ˆí‹°</span>
                        </button>
                    </div>
                </nav>

                <!-- Sub View Containers -->
                <div id="procedure-views-container" class="flex-1 mt-4 sm:mt-0">
                    
                    <!-- 1. ê°œìš” ë·° (Overview View) -->
                    <div id="overview-view" class="app-view-sub flex-col hidden min-h-[400px]">
                        <!-- Content rendered by JS (renderOverviewView) -->
                    </div>
                    
                    <!-- 2. ìˆ ê¸° ì˜ìƒ ë·° (Procedure Learning View) -->
                    <div id="procedure-learning-view" class="app-view-sub flex-col hidden min-h-[400px]">
                        <!-- Content rendered by JS (renderProcedureLearningView) -->
                    </div>
                    
                    <!-- 3. ì²´í¬ë¦¬ìŠ¤íŠ¸ ë·° (Checklist View) -->
                    <div id="checklist-view" class="app-view-sub flex-col hidden min-h-[400px]">
                        <!-- Content rendered by JS (renderChecklistView) -->
                    </div>

                    <!-- 4. ê¸°ë¡ ì´ˆì•ˆ ë·° (Charting View) -->
                    <div id="charting-view" class="app-view-sub flex-col hidden min-h-[400px]">
                        <!-- Content rendered by JS (renderChartingView) -->
                    </div>

                    <!-- 5. í•™ìŠµ ì§„ë„ ë·° (Progress View) -->
                    <div id="progress-view" class="app-view-sub flex-col hidden min-h-[400px]">
                        <h3 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">í™œë ¥ì§•í›„ ì¸¡ì • í•™ìŠµ ì§„ë„</h3>

                        <div class="bg-indigo-50 p-6 rounded-xl shadow-inner mb-6">
                            <p class="text-lg font-semibold text-indigo-700 mb-2">ì´ í‰ê°€ í‰ê·  ì ìˆ˜</p>
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-indigo-600 font-medium">í‰ê·  ì ìˆ˜:</span>
                                <span id="average-score" class="text-xl font-bold text-indigo-800">0%</span>
                            </div>
                            <!-- Progress Bar -->
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div id="overall-progress-chart" class="progress-bar-fill h-3 bg-indigo-500 rounded-full" style="width: 0%"></div>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">ìµœê·¼ ì €ì¥ëœ í‰ê°€ ì ìˆ˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì§„ë„ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                        </div>

                        <!-- Progress Records List -->
                        <h3 class="text-xl font-bold text-gray-700 mb-4">ìµœê·¼ í‰ê°€ ê¸°ë¡</h3>
                        <div id="progress-list" class="space-y-3">
                            <div class="p-6 text-center text-gray-500 bg-white rounded-xl shadow-sm">ë°ì´í„° ë¡œë“œ ì¤‘...</div>
                        </div>
                    </div>

                    <!-- 6. ì»¤ë®¤ë‹ˆí‹° ë·° (Community View) - Mockup -->
                    <div id="community-view" class="app-view-sub flex-col hidden items-center justify-center p-8 text-center min-h-[400px]">
                        <i data-lucide="message-square-text" class="w-16 h-16 text-blue-500 mb-4"></i>
                        <h2 class="text-2xl font-bold text-gray-700 mb-2">í˜‘ë ¥ì  í•™ìŠµ ì»¤ë®¤ë‹ˆí‹° (ê°œë°œ ì˜ˆì •)</h2>
                        <p class="text-gray-500">ì§ˆë¬¸, ì •ë³´ ê³µìœ , ì¶”ì²œ ì½˜í…ì¸  ë“±ë¡ ë“± ìƒí˜¸ì‘ìš©ì„ ì´‰ì§„í•˜ëŠ” ì†Œì…œ ê¸°ëŠ¥ì´ ì¶”ê°€ë  ì˜ˆì •ì…ë‹ˆë‹¤.</p>
                        <div class="mt-6 w-full max-w-sm p-4 bg-blue-50 rounded-lg border border-blue-300">
                            <p class="font-medium text-sm text-blue-700">ì§ˆì˜ì‘ë‹µ ê²Œì‹œíŒ ëª©ì—… ì¤€ë¹„ ì¤‘...</p>
                        </div>
                    </div>

                </div>

                <!-- Step Navigation (Only visible for Procedure Learning Tab) -->
                <div id="step-navigation" class="flex justify-center items-center py-4 border-t hidden">
                    <button id="prev-step-btn" class="flex items-center justify-center px-4 py-2 text-sm font-medium rounded-lg text-white ${currentStep > 1 ? 'bg-indigo-500 hover:bg-indigo-600' : 'bg-gray-300 cursor-not-allowed'}" 
                            ${currentStep === 1 ? 'disabled' : ''} onclick="changeStep(-1)">
                        <i data-lucide="chevron-left" class="w-5 h-5 mr-1"></i> ì´ì „ ë‹¨ê³„
                    </button>
                    <span class="text-indigo-800 font-semibold mx-4">${currentStep} / ${VITAL_SIGN_STEPS.length}</span>
                    <button id="next-step-btn" class="flex items-center justify-center px-4 py-2 text-sm font-medium rounded-lg text-white ${currentStep < VITAL_SIGN_STEPS.length ? 'bg-indigo-500 hover:bg-indigo-600' : 'bg-gray-300 cursor-not-allowed'}" 
                            ${currentStep === VITAL_SIGN_STEPS.length ? 'disabled' : ''} onclick="changeStep(1)">
                        ë‹¤ìŒ ë‹¨ê³„ <i data-lucide="chevron-right" class="w-5 h-5 ml-1"></i>
                    </button>
                </div>

            </div>
        </div>

        <!-- Footer for padding on mobile -->
        <footer class="h-16 sm:h-0"></footer>
    </div>
</body>
</html>
